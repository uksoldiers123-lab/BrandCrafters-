<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard — BrandCrafters</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    .status-pill {
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.25);
      opacity:.95;
      white-space:nowrap;
    }
    .status-new { background:rgba(110,168,255,.18); }
    .status-in_progress { background:rgba(240,196,25,.18); }
    .status-done { background:rgba(72,199,116,.18); }

    .btn-mini {
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.04);
      cursor:pointer;
    }

    .status-filter-wrap {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
    }
    .status-filter-wrap select {
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(20,18,32,.9);
      color:inherit;
      font:inherit;
    }
  </style>
</head>
<body>

<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <nav class="nav desktop-nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="nav-link">Customer Portal</a>
      <a href="dashboard.html" class="nav-link active">Admin</a>
    </nav>

    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <nav class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close" aria-label="Close menu">✕</button>
    </div>
    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>
    <a class="drawer-link highlight" href="dashboard.html">Admin</a>
  </nav>

  <div class="drawer-backdrop" aria-hidden="true"></div>

</header>

<section class="page-hero">
  <div class="container">
    <h1 class="headline">Admin Dashboard</h1>
    <p class="subhead">
      Your full control center for orders, support, maintenance, and project links.<br>
      This panel is <b>admin-only</b> with Supabase Auth.
    </p>
  </div>
</section>

<section class="container">

  <!-- AUTH SECTION -->
  <div id="authSection" class="form glass" style="max-width:420px;margin:0 auto 40px;display:none;">
    <h2>Admin Sign In</h2>
    <form id="loginForm">
      <label>Email <input type="email" name="email" required /></label>
      <label>Password <input type="password" name="password" required /></label>
      <button class="btn btn-primary" type="submit">Sign In</button>
      <p id="loginMsg" class="form-note"></p>
    </form>
  </div>

  <!-- ADMIN APP -->
  <div id="appSection" style="display:none;">

    <div class="card" style="margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
        <div>
          <h2 style="margin:0;">Summary</h2>
          <p id="summaryText" class="subhead" style="margin:0;">Loading…</p>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
          <div class="status-filter-wrap">
            <span>Show:</span>
            <select id="statusFilter">
              <option value="new">New Only</option>
              <option value="in_progress">In Progress Only</option>
              <option value="not_done">Incomplete (New + In Progress)</option>
              <option value="done">Done Only</option>
              <option value="maintenance">Maintenance Clients</option>
              <option value="all">All Statuses</option>
            </select>
          </div>

          <button id="logoutBtn" class="btn btn-ghost">Log Out</button>
        </div>
      </div>
    </div>

    <div class="cta-row" style="justify-content:flex-start;gap:10px;margin-bottom:20px;">
      <button id="tabOnboarding" class="btn btn-primary">Website Orders</button>
      <button id="tabSupport" class="btn btn-ghost">Support Requests</button>
    </div>

    <!-- ONBOARDING TABLE -->
    <section id="onboardingSection">
      <h2>Website Orders</h2>
      <div class="glass" style="overflow-x:auto;padding:0;margin-top:10px;">
        <table style="width:100%;border-collapse:collapse;font-size:14px;">
          <thead>
            <tr>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Created</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Client</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Business</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Package</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Pages</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Add-ons</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Status</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Project Links / Stack</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Notes</th>
            </tr>
          </thead>
          <tbody id="onboardingBody">
            <tr><td colspan="9" style="padding:10px;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- SUPPORT TABLE -->
    <section id="supportSection" style="display:none;">
      <h2>Support Requests</h2>
      <div class="glass" style="overflow-x:auto;padding:0;margin-top:10px;">
        <table style="width:100%;border-collapse:collapse;font-size:14px;">
          <thead>
            <tr>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Created</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Client</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Business</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Type</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Urgency</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Status</th>
              <th style="padding:10px;border-bottom:1px solid rgba(255,255,255,.12);">Details</th>
            </tr>
          </thead>
          <tbody id="supportBody">
            <tr><td colspan="7" style="padding:10px;">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </div>
</section>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>© <span id="year"></span> BrandCrafters — Admin</div>
  </div>
</footer>

<!-- JS -->
<script type="module">

  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const supabase = createClient(
    "https://vekoulqehexqosgwacwa.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4"
  );

  document.getElementById("year").textContent = new Date().getFullYear();

  const authSection = document.getElementById("authSection");
  const appSection = document.getElementById("appSection");
  const loginForm = document.getElementById("loginForm");
  const loginMsg = document.getElementById("loginMsg");
  const logoutBtn = document.getElementById("logoutBtn");

  const onboardingBody = document.getElementById("onboardingBody");
  const supportBody = document.getElementById("supportBody");
  const summaryText = document.getElementById("summaryText");

  const onboardingSection = document.getElementById("onboardingSection");
  const supportSection = document.getElementById("supportSection");

  const tabOnboarding = document.getElementById("tabOnboarding");
  const tabSupport = document.getElementById("tabSupport");

  const statusFilterSelect = document.getElementById("statusFilter");

  let onbData = [];
  let supData = [];
  let statusFilter = "new";

  /* Utility */
  function shorten(text, max = 120) {
    if (!text) return "";
    text = String(text);
    return text.length > max ? text.slice(0, max) + "…" : text;
  }

  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    return d.toLocaleString();
  }

  function humanStatus(s) {
    if (!s || s === "new") return "New";
    if (s === "in_progress") return "In Progress";
    if (s === "done") return "Done";
    return s;
  }

  function nextStatus(s) {
    if (!s || s === "new") return "in_progress";
    if (s === "in_progress") return "done";
    return "new";
  }

  function isMaintenanceRow(row, table) {
    if (table === "onboarding_submissions") {
      const addons = Array.isArray(row.addons) ? row.addons : [];
      const t = addons.join(" ").toLowerCase();
      return (
        t.includes("care lite") ||
        t.includes("care standard") ||
        t.includes("care pro")
      );
    }
    if (table === "support_requests") {
      const rt = (row.request_type || "").toLowerCase();
      return rt.includes("maintenance");
    }
    return false;
  }

  /* Main filters */
  function statusPass(row, table) {
    const s = row.status || "new";

    switch (statusFilter) {
      case "new": return s === "new";
      case "in_progress": return s === "in_progress";
      case "not_done": return s !== "done";
      case "done": return s === "done";
      case "maintenance": return isMaintenanceRow(row, table);
      default: return true;
    }
  }

  /* Update row status */
  async function updateStatus(table, id, currentStatus) {
    const newStatus = nextStatus(currentStatus);

    if (table === "onboarding_submissions") {
      onbData = onbData.map(r => r.id === id ? { ...r, status: newStatus } : r);
    } else {
      supData = supData.map(r => r.id === id ? { ...r, status: newStatus } : r);
    }
    renderTables();

    const { error } = await supabase
      .from(table)
      .update({ status:newStatus })
      .eq("id", id);

    if (error) alert("Error saving status");
  }

  /* Edit project info popup */
  async function editProject(id) {
    const row = onbData.find(r => r.id == id);
    if (!row) return;

    const live = prompt("Live website URL:", row.live_url || "");
    if (live === null) return;

    const repo = prompt("GitHub/Replit repo URL:", row.repo_url || "");
    if (repo === null) return;

    const stack = prompt("Stack notes (Supabase, Stripe, Email, Replit, etc.):", row.stack_notes || "");
    if (stack === null) return;

    const updated = {
      live_url: live.trim() || null,
      repo_url: repo.trim() || null,
      stack_notes: stack.trim() || null
    };

    onbData = onbData.map(r =>
      r.id === id ? { ...r, ...updated } : r
    );
    renderTables();

    const { error } = await supabase
      .from("onboarding_submissions")
      .update(updated)
      .eq("id", id);

    if (error) {
      alert("Error saving project info");
    }
  }

  /* Attach handlers */
  function attachHandlers() {
    document.querySelectorAll("[data-status-id]").forEach(pill => {
      pill.addEventListener("click", () => {
        updateStatus(
          pill.dataset.table,
          pill.dataset.statusId,
          pill.dataset.status
        );
      });
    });

    document.querySelectorAll("[data-edit-id]").forEach(btn => {
      btn.addEventListener("click", () => editProject(btn.dataset.editId));
    });
  }

  /* Render tables */
  function renderTables() {

    /* ONBOARDING */
    onboardingBody.innerHTML = "";
    let filteredOnb = onbData.filter(row => statusPass(row, "onboarding_submissions"));
    if (filteredOnb.length === 0) {
      onboardingBody.innerHTML = `<tr><td colspan="9" style="padding:10px;">No orders in this view.</td></tr>`;
    } else {
      filteredOnb.forEach(row => {
        const st = row.status || "new";

        const links = `
          ${row.live_url ? `<div><a href="${row.live_url}" target="_blank">Live</a></div>` : ""}
          ${row.repo_url ? `<div><a href="${row.repo_url}" target="_blank">Repo</a></div>` : ""}
          ${row.stack_notes ? `<div style="font-size:12px;opacity:.7;">${shorten(row.stack_notes,80)}</div>` : ""}
          <button class="btn-mini" data-edit-id="${row.id}">Edit</button>
        `;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:8px;">${formatDate(row.created_at)}</td>
          <td style="padding:8px;">
            <div><b>${row.name}</b></div>
            <div style="font-size:12px;opacity:.7;">${row.email}</div>
          </td>
          <td style="padding:8px;">${shorten(row.business_name,40)}</td>
          <td style="padding:8px;">${row.package_name}</td>
          <td style="padding:8px;">${(row.pages||[]).join(", ")}</td>
          <td style="padding:8px;">${(row.addons||[]).join(", ")}</td>
          <td style="padding:8px;">
            <span class="status-pill status-${st}"
                  data-status-id="${row.id}"
                  data-table="onboarding_submissions"
                  data-status="${st}">
              ${humanStatus(st)}
            </span>
          </td>
          <td style="padding:8px;">${links}</td>
          <td style="padding:8px;">${shorten(row.page_notes||row.extra_notes,120)}</td>
        `;
        onboardingBody.appendChild(tr);
      });
    }

    /* SUPPORT */
    supportBody.innerHTML = "";
    let filteredSup = supData.filter(row => statusPass(row, "support_requests"));
    if (filteredSup.length === 0) {
      supportBody.innerHTML = `<tr><td colspan="7" style="padding:10px;">No requests in this view.</td></tr>`;
    } else {
      filteredSup.forEach(row => {
        const st = row.status || "new";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="padding:8px;">${formatDate(row.created_at)}</td>
          <td style="padding:8px;">
            <div><b>${row.name}</b></div>
            <div style="font-size:12px;opacity:.7;">${row.email}</div>
          </td>
          <td style="padding:8px;">${shorten(row.business,40)}</td>
          <td style="padding:8px;">${row.request_type}</td>
          <td style="padding:8px;">${row.urgency}</td>
          <td style="padding:8px;">
            <span class="status-pill status-${st}"
                  data-status-id="${row.id}"
                  data-table="support_requests"
                  data-status="${st}">
              ${humanStatus(st)}
            </span>
          </td>
          <td style="padding:8px;">${shorten(row.details,160)}</td>
        `;
        supportBody.appendChild(tr);
      });
    }

    attachHandlers();
  }

  async function loadData() {
    summaryText.textContent = "Loading…";

    const [onbRes, supRes] = await Promise.all([
      supabase.from("onboarding_submissions").select("*").order("created_at",{ascending:false}),
      supabase.from("support_requests").select("*").order("created_at",{ascending:false})
    ]);

    onbData = onbRes.data || [];
    supData = supRes.data || [];

    summaryText.textContent =
      `Orders: ${onbData.length} — Requests: ${supData.length}`;

    renderTables();
  }

  /* Tab switching */
  tabOnboarding.addEventListener("click", () => {
    onboardingSection.style.display = "";
    supportSection.style.display = "none";
    tabOnboarding.classList.add("btn-primary");
    tabSupport.classList.remove("btn-primary");
    tabSupport.classList.add("btn-ghost");
  });

  tabSupport.addEventListener("click", () => {
    onboardingSection.style.display = "none";
    supportSection.style.display = "";
    tabSupport.classList.add("btn-primary");
    tabOnboarding.classList.remove("btn-primary");
    tabOnboarding.classList.add("btn-ghost");
  });

  statusFilterSelect.addEventListener("change", () => {
    statusFilter = statusFilterSelect.value;
    renderTables();
  });

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginMsg.textContent = "Signing in…";
    const fd = new FormData(loginForm);

    const { error } = await supabase.auth.signInWithPassword({
      email: fd.get("email"),
      password: fd.get("password")
    });

    if (error) {
      loginMsg.textContent = "Invalid login.";
      return;
    }

    loginMsg.textContent = "";
    authSection.style.display = "none";
    appSection.style.display = "";
    loadData();
  });

  logoutBtn.addEventListener("click", async () => {
    await supabase.auth.signOut();
    appSection.style.display = "none";
    authSection.style.display = "";
  });

  (async () => {
    const { data } = await supabase.auth.getUser();
    if (data?.user) {
      authSection.style.display = "none";
      appSection.style.display = "";
      loadData();
    } else {
      authSection.style.display = "";
      appSection.style.display = "none";
    }
  })();

</script>

</body>
</html>
