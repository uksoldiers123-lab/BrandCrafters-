<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script defer src="script.js"></script>
  <style>
    /* Dashboard-only helpers (piggyback on your existing styles) */
    body.admin-body { margin:0; }
    .main-content { padding:24px 20px 60px; }
    .grid-3 { display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:16px; }
    .grid-2 { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px; }
    @media (max-width:900px){
      .grid-3,.grid-2{ grid-template-columns:1fr; }
    }
    .card.stat-card { min-height:120px; }
    .stat-label { font-size:12px; text-transform:uppercase; letter-spacing:.06em; color:var(--muted); }
    .stat-value { font-size:24px; font-weight:700; margin:6px 0 4px; }
    .muted { color:var(--muted); font-size:13px; }
    .table { width:100%; border-collapse:collapse; font-size:13px; margin-top:8px; }
    .table th,.table td { border-bottom:1px solid rgba(255,255,255,.08); padding:6px 5px; vertical-align:top; }
    .table th { font-size:11px; text-transform:uppercase; letter-spacing:.05em; color:var(--muted); text-align:left; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:11px; }
    .pill-green{ background:rgba(155,255,191,.15); }
    .pill-red{ background:rgba(255,155,155,.15); }
    .pill-blue{ background:rgba(110,168,255,.15); }
    .admin-email { font-size:12px; color:var(--muted); margin-right:4px; }
    #loginBox label { display:block; margin-bottom:10px; font-size:14px; }
    #loginBox input { width:100%; margin-top:4px; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16); background:rgba(20,18,32,.6); color:var(--text); }
  </style>
</head>

<body class="admin-body">

<!-- HEADER (same BC icon + menu style as index) -->
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <!-- Desktop Nav -->
    <nav class="nav desktop-nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="nav-link">Customer Portal</a>
      <a href="dashboard.html" class="nav-link active">Admin</a>

      <span id="userEmail" class="admin-email"></span>
      <button id="logoutBtn" class="btn btn-outline">Logout</button>
    </nav>

    <!-- Mobile: Hamburger -->
    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <!-- Mobile Drawer -->
  <nav class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close" aria-label="Close menu">✕</button>
    </div>
    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>
    <a class="drawer-link highlight" href="dashboard.html">Admin</a>
    <button class="drawer-link" id="logoutBtnMobile">Logout</button>
  </nav>
  <div class="drawer-backdrop" aria-hidden="true"></div>
</header>

<main class="main-content container">

  <!-- LOGIN BOX (shown when no user logged in) -->
  <section id="loginBox" class="card" style="max-width:380px;margin:40px auto;display:none;">
    <h1 style="margin-top:0;">Admin / Contractor Login</h1>
    <p class="subhead">
      Use your BrandCrafters login. Admin sees this dashboard. Contractors are sent to the Contractor Portal.
    </p>

    <label>Email
      <input id="loginEmail" type="email" placeholder="you@example.com" required />
    </label>
    <label>Password
      <input id="loginPassword" type="password" placeholder="••••••••" required />
    </label>

    <button id="loginBtn" class="btn btn-primary" style="margin-top:12px;width:100%;">Login</button>
    <p id="loginMsg" class="muted" style="margin-top:10px;"></p>
  </section>

  <!-- DASHBOARD CONTENT (only shown for ADMIN) -->
  <section id="dashboardContent" style="display:none;">
    <section>
      <h1>Admin Overview</h1>
      <p class="subhead">
        Money snapshot, projects, recurring bills, and lead performance — all in one place.
      </p>
    </section>

    <!-- MONEY SUMMARY -->
    <section class="grid-3" style="margin-bottom:16px;">
      <article class="card stat-card">
        <div class="stat-label">Lifetime Project Revenue (one-time)</div>
        <div class="stat-value" id="lifetimeRevenue">$0.00</div>
        <div class="muted">Sum of total_price on onboarding submissions.</div>
      </article>

      <article class="card stat-card">
        <div class="stat-label">Active Monthly Income</div>
        <div class="stat-value" id="monthlyIncome">$0.00</div>
        <div class="muted">Sum of monthly_fee for projects with monthly_fee &gt; 0.</div>
      </article>

      <article class="card stat-card">
        <div class="stat-label">Active Monthly Bills</div>
        <div class="stat-value" id="monthlyBills">$0.00</div>
        <div class="muted">Active recurring_expenses with frequency = 'monthly'.</div>
      </article>
    </section>

    <!-- PROFITS & LEADS -->
    <section class="grid-3" style="margin-bottom:16px;">
      <article class="card stat-card">
        <div class="stat-label">Est. Monthly Net (Maintenance - Bills)</div>
        <div class="stat-value" id="monthlyNet">$0.00</div>
        <div class="muted">Quick check if maintenance covers recurring expenses.</div>
      </article>

      <article class="card stat-card">
        <div class="stat-label">Closed Won Leads · This Month</div>
        <div class="stat-value" id="closedWonMonth">0</div>
        <div class="muted">
          call_leads where call_status = 'closed won' and last_contact_date in this month.
        </div>
      </article>

      <article class="card stat-card">
        <div class="stat-label">Estimated Commissions · This Month</div>
        <div class="stat-value" id="commissionMonth">$0.00</div>
        <div class="muted">
          Rough estimate based on closed won leads (we can refine later).
        </div>
      </article>
    </section>

    <!-- PROJECTS & EXPENSES -->
    <section class="grid-2" style="margin-bottom:16px;">
      <article class="card">
        <h2>Client Projects (Onboarding)</h2>
        <p class="muted">
          Last 6 onboarding submissions with total price, monthly fee, and status.
        </p>
        <table class="table" id="projectsTable">
          <thead>
            <tr>
              <th>Client</th>
              <th>Total Price</th>
              <th>Monthly Fee</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </article>

      <article class="card">
        <h2>Upcoming Recurring Bills</h2>
        <p class="muted">
          Next 6 active recurring_expenses sorted by next_due_date.
        </p>
        <table class="table" id="billsTable">
          <thead>
            <tr>
              <th>Bill</th>
              <th>Due</th>
              <th>Vendor</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="muted" id="billsNote"></p>
      </article>
    </section>

    <!-- LEAD SNAPSHOT -->
    <section class="card" style="margin-bottom:24px;">
      <h2>Lead Pipeline Snapshot</h2>
      <p class="muted">
        Quick health check before you dive into the full Leads dashboard.
      </p>
      <div class="grid-2">
        <div>
          <p class="stat-label">Counts by Status</p>
          <p class="muted" id="leadStatusStats">Loading…</p>
        </div>
        <div>
          <p class="stat-label">Top Callers (Closed Won)</p>
          <table class="table" id="topCallersTable">
            <thead>
              <tr>
                <th>Caller</th>
                <th>Closed Won</th>
                <th>Est. Commission</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>
      © <span id="year"></span> BrandCrafters — A division of Egyptian Hype LLC
      <a href="dashboard.html" class="admin-link">Admin</a>
    </div>
  </div>
</footer>
<script>
  document.getElementById('year').textContent = new Date().getFullYear();
</script>

<!-- SUPABASE + LOGIC -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL  = "https://vekoulqehexqosgwacwa.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
const ADMIN_EMAIL   = "srarnold216@gmail.com";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

// DOM refs
const userEmailSpan   = document.getElementById("userEmail");
const loginBox        = document.getElementById("loginBox");
const dashboardContent= document.getElementById("dashboardContent");
const loginBtn        = document.getElementById("loginBtn");
const loginEmailInput = document.getElementById("loginEmail");
const loginPwInput    = document.getElementById("loginPassword");
const loginMsg        = document.getElementById("loginMsg");
const logoutBtn       = document.getElementById("logoutBtn");
const logoutBtnMobile = document.getElementById("logoutBtnMobile");

// Dashboard metric refs
const lifetimeRevenue = document.getElementById("lifetimeRevenue");
const monthlyIncome   = document.getElementById("monthlyIncome");
const monthlyBills    = document.getElementById("monthlyBills");
const monthlyNet      = document.getElementById("monthlyNet");
const closedWonMonth  = document.getElementById("closedWonMonth");
const commissionMonth = document.getElementById("commissionMonth");

const projectsTableBody   = document.querySelector("#projectsTable tbody");
const billsTableBody      = document.querySelector("#billsTable tbody");
const billsNote           = document.getElementById("billsNote");
const leadStatusStats     = document.getElementById("leadStatusStats");
const topCallersTableBody = document.querySelector("#topCallersTable tbody");

// Helpers
function formatMoney(n) {
  if (n === null || n === undefined || isNaN(Number(n))) return "$0.00";
  return "$" + Number(n).toFixed(2);
}
function startOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}
function endOfMonth(date) {
  return new Date(date.getFullYear(), date.getMonth() + 1, 0);
}

// MAIN GUARD + ROUTER
async function guardAndRoute() {
  const { data } = await supabaseClient.auth.getUser();

  // Not logged in: show login box, hide admin dashboard
  if (!data || !data.user) {
    userEmailSpan.textContent = "";
    loginBox.style.display = "block";
    dashboardContent.style.display = "none";
    return;
  }

  const email = data.user.email || "";
  userEmailSpan.textContent = email;

  // Admin
  if (email === ADMIN_EMAIL) {
    loginBox.style.display = "none";
    dashboardContent.style.display = "block";
    await loadDashboard();
  } else {
    // Non-admin -> contractor portal
    window.location.href = "contractor-portal.html";
  }
}

// LOGIN HANDLER
loginBtn.addEventListener("click", async () => {
  const email = loginEmailInput.value.trim();
  const pw    = loginPwInput.value.trim();

  if (!email || !pw) {
    loginMsg.textContent = "Please enter email and password.";
    return;
  }

  loginMsg.textContent = "Checking…";

  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password: pw
  });

  if (error) {
    console.error(error);
    loginMsg.textContent = "Login failed — check your credentials.";
  } else {
    loginMsg.textContent = "Success. Loading dashboard…";
    await guardAndRoute();
  }
});

// LOGOUT HANDLERS (back to login view)
async function doLogout() {
  await supabaseClient.auth.signOut();
  await guardAndRoute();
}
logoutBtn?.addEventListener("click", doLogout);
logoutBtnMobile?.addEventListener("click", doLogout);

// LOAD ADMIN DASHBOARD DATA
async function loadDashboard() {
  const today = new Date();
  const monthStart = startOfMonth(today);
  const monthEnd   = endOfMonth(today);

  const [onboardingRes, billsRes, leadsRes] = await Promise.all([
    supabaseClient.from("onboarding_submissions").select("*"),
    supabaseClient.from("recurring_expenses").select("*").eq("is_active", true),
    supabaseClient.from("call_leads").select("*")
  ]);

  if (onboardingRes.error) console.error("Onboarding error:", onboardingRes.error);
  if (billsRes.error)      console.error("Bills error:", billsRes.error);
  if (leadsRes.error)      console.error("Leads error:", leadsRes.error);

  const onboarding = onboardingRes.data || [];
  const bills      = billsRes.data || [];
  const leads      = leadsRes.data || [];

  // MONEY SUMMARY
  let lifetimeRev       = 0;
  let monthlyFeeTotal   = 0;
  let monthlyBillsTotal = 0;

  onboarding.forEach(p => {
    if (p.total_price) lifetimeRev     += Number(p.total_price) || 0;
    if (p.monthly_fee) monthlyFeeTotal += Number(p.monthly_fee) || 0;
  });

  bills.forEach(b => {
    if (b.frequency === "monthly" && b.amount) {
      monthlyBillsTotal += Number(b.amount) || 0;
    }
  });

  lifetimeRevenue.textContent = formatMoney(lifetimeRev);
  monthlyIncome.textContent   = formatMoney(monthlyFeeTotal);
  monthlyBills.textContent    = formatMoney(monthlyBillsTotal);
  monthlyNet.textContent      = formatMoney(monthlyFeeTotal - monthlyBillsTotal);

  // PROJECTS TABLE (last 6)
  projectsTableBody.innerHTML = "";
  onboarding
    .sort((a, b) => new Date(b.created_at || b.first_paid_at || 0) - new Date(a.created_at || a.first_paid_at || 0))
    .slice(0, 6)
    .forEach(p => {
      const tr = document.createElement("tr");
      const clientName = p.business_name || p.client_name || "(No name)";
      const status     = (p.status || "new").toLowerCase();

      const tdClient = document.createElement("td");
      tdClient.innerHTML = `<strong>${clientName}</strong><br><span class="muted">${p.currency || "USD"}</span>`;
      tr.appendChild(tdClient);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = p.total_price ? formatMoney(p.total_price) : "—";
      tr.appendChild(tdTotal);

      const tdMonthly = document.createElement("td");
      tdMonthly.textContent = p.monthly_fee ? formatMoney(p.monthly_fee) : "—";
      tr.appendChild(tdMonthly);

      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      const pillCls =
        status === "completed" ? "pill pill-green" :
        status === "cancelled" ? "pill pill-red"  :
                                 "pill pill-blue";
      pill.className = pillCls;
      pill.textContent = status;
      tdStatus.appendChild(pill);
      tr.appendChild(tdStatus);

      projectsTableBody.appendChild(tr);
    });

  // BILLS TABLE
  billsTableBody.innerHTML = "";
  bills
    .filter(b => b.next_due_date)
    .sort((a,b) => new Date(a.next_due_date) - new Date(b.next_due_date))
    .slice(0,6)
    .forEach(b => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.innerHTML = `<strong>${b.name}</strong><br><span class="muted">${b.category || ""}</span>`;
      tr.appendChild(tdName);

      const tdDue = document.createElement("td");
      tdDue.textContent = b.next_due_date || "";
      tr.appendChild(tdDue);

      const tdVendor = document.createElement("td");
      tdVendor.textContent = b.vendor || "";
      tr.appendChild(tdVendor);

      const tdAmt = document.createElement("td");
      tdAmt.textContent = formatMoney(b.amount);
      tr.appendChild(tdAmt);

      billsTableBody.appendChild(tr);
    });

  billsNote.textContent = bills.length
    ? ""
    : "No recurring_expenses yet. Add them in Supabase when you start paying tools/domains/email.";

  // LEADS SNAPSHOT
  const statusCounts      = {};
  let closedThisMonth     = 0;
  let commissionThisMonth = 0;
  const callerStats       = new Map();

  leads.forEach(ld => {
    const status = (ld.call_status || "new").toLowerCase();
    statusCounts[status] = (statusCounts[status] || 0) + 1;

    // this-month closed won
    if (status === "closed won" && ld.last_contact_date) {
      const d = new Date(ld.last_contact_date);
      if (d >= startOfMonth(today) && d <= endOfMonth(today)) {
        closedThisMonth += 1;
        // rough: treat each closed site as $100 for now (base only)
        commissionThisMonth += 100;
      }
    }

    // per-caller stats
    if (ld.assigned_caller_email) {
      const email = ld.assigned_caller_email;
      if (!callerStats.has(email)) {
        callerStats.set(email, { closedWon:0, commission:0 });
      }
      const obj = callerStats.get(email);
      if (status === "closed won") {
        obj.closedWon += 1;
        obj.commission += 100; // same rough estimate
      }
    }
  });

  closedWonMonth.textContent  = closedThisMonth;
  commissionMonth.textContent = formatMoney(commissionThisMonth);

  // Status counts text
  const parts = [];
  Object.entries(statusCounts).forEach(([s, count]) => {
    parts.push(`${s}: ${count}`);
  });
  leadStatusStats.textContent = parts.length ? parts.join(" · ") : "No leads yet.";

  // Top callers table
  topCallersTableBody.innerHTML = "";
  const sortedCallers = Array.from(callerStats.entries())
    .sort((a,b) => b[1].commission - a[1].commission)
    .slice(0,5);

  if (!sortedCallers.length) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 3;
    td.className = "muted";
    td.textContent = "No closed-won leads yet.";
    tr.appendChild(td);
    topCallersTableBody.appendChild(tr);
  } else {
    sortedCallers.forEach(([email, stats]) => {
      const tr = document.createElement("tr");

      const tdEmail = document.createElement("td");
      tdEmail.textContent = email;
      tr.appendChild(tdEmail);

      const tdClosed = document.createElement("td");
      tdClosed.textContent = stats.closedWon;
      tr.appendChild(tdClosed);

      const tdComm = document.createElement("td");
      tdComm.textContent = formatMoney(stats.commission);
      tr.appendChild(tdComm);

      topCallersTableBody.appendChild(tr);
    });
  }
}

// Init
(async () => {
  await guardAndRoute();
})();
</script>

</body>
</html>
