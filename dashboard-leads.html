<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Lead List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script defer src="script.js"></script>
  <style>
    body.dashboard-body { margin:0; }
    .main-content { padding:24px 20px 80px; }

    .grid-4 {
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:16px;
    }
    .grid-2 {
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:16px;
    }
    @media (max-width:1100px){
      .grid-4{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:780px){
      .grid-4,.grid-2{ grid-template-columns:1fr; }
    }

    .stat-label {
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
    }
    .stat-value {
      font-size:24px;
      font-weight:700;
      margin:6px 0 4px;
    }
    .muted { color:var(--muted); font-size:13px; }

    .table-wrap { width:100%; overflow-x:auto; }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      min-width:780px;
    }
    th,td {
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:6px 5px;
      vertical-align:top;
      text-align:left;
    }
    th {
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
    }

    .pill {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
    }
    .pill-blue  { background:rgba(110,168,255,.18); }
    .pill-green { background:rgba(155,255,191,.18); }
    .pill-red   { background:rgba(255,155,155,.18); }
    .pill-gray  { background:rgba(200,200,220,.15); }

    .btn-small {
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.06);
      cursor:pointer;
      margin-right:4px;
      margin-top:2px;
    }
    .btn-small.primary {
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
      font-weight:600;
    }
    .btn-small:disabled {
      opacity:.5;
      cursor:not-allowed;
    }

    .admin-subnav {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin:8px 0 20px;
    }
    .admin-subnav a {
      font-size:13px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      text-decoration:none;
      color:var(--text);
      transition:.18s;
    }
    .admin-subnav a:hover {
      background:rgba(255,255,255,.10);
      transform:translateY(-1px);
    }
    .admin-subnav a.active {
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
      font-weight:600;
    }

    .admin-email { font-size:12px; color:var(--muted); margin-right:4px; }

    .filters-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .filters-row select,
    .filters-row input {
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(20,18,32,.7);
      color:var(--text);
      font-size:13px;
    }

    @media (max-width:640px){
      .main-content { padding:16px 14px 70px; }
      h1 { font-size:20px; }
      .stat-value { font-size:20px; }
      .admin-subnav { flex-direction:column; }
      .admin-subnav a { width:100%; text-align:center; }
      table { min-width:0; font-size:12px; }
    }
  </style>
</head>

<body class="dashboard-body">

<!-- HEADER -->
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <nav class="nav desktop-nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="nav-link">Customer Portal</a>
      <a href="dashboard.html" class="nav-link active">Admin</a>

      <span id="userEmail" class="admin-email"></span>
      <button id="logoutBtn" class="btn btn-outline">Logout</button>
    </nav>

    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <nav class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close" aria-label="Close menu">✕</button>
    </div>
    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>
    <a class="drawer-link highlight" href="dashboard.html">Admin</a>
    <button class="drawer-link" id="logoutBtnMobile">Logout</button>
  </nav>
  <div class="drawer-backdrop" aria-hidden="true"></div>
</header>

<main class="main-content container">
  <section>
    <h1>Lead List</h1>
    <p class="subhead">
      Full view of all leads in your system. Filter by status or search by business, niche, or caller.
    </p>

    <!-- ADMIN DASH NAV -->
    <nav class="admin-subnav">
      <a href="dashboard.html">Overview</a>
      <a href="dashboard-leads.html" class="active">Lead List</a>
      <a href="dashboard-leads-upload.html">Upload Leads</a>
      <a href="dashboard-demos.html">Demo Library</a>
      <a href="dashboard-communications.html">Scripts &amp; Messages</a>
      <a href="dashboard-commissions.html">Commissions</a>
      <a href="dashboard-settings.html">Settings</a>
      <a href="contractor-portal.html">Contractor Portal</a>
    </nav>
  </section>

  <!-- STATS -->
  <section class="grid-4" style="margin-bottom:16px;">
    <article class="card">
      <div class="stat-label">Total Leads</div>
      <div class="stat-value" id="totalLeads">0</div>
      <div class="muted">All rows in call_leads.</div>
    </article>
    <article class="card">
      <div class="stat-label">Open</div>
      <div class="stat-value" id="openLeads">0</div>
      <div class="muted">new · in progress · follow up</div>
    </article>
    <article class="card">
      <div class="stat-label">Closed Won</div>
      <div class="stat-value" id="wonLeads">0</div>
      <div class="muted">Deals you’ve closed.</div>
    </article>
    <article class="card">
      <div class="stat-label">Closed Lost / DNC</div>
      <div class="stat-value" id="lostLeads">0</div>
      <div class="muted">closed lost · do not contact</div>
    </article>
  </section>

  <!-- FILTERS + TABLE -->
  <section class="card">
    <div class="filters-row">
      <label class="muted">Status
        <select id="statusFilter">
          <option value="all">All</option>
          <option value="open">Open (new / in progress / follow up)</option>
          <option value="new">new</option>
          <option value="in progress">in progress</option>
          <option value="follow up">follow up</option>
          <option value="closed won">closed won</option>
          <option value="closed lost">closed lost</option>
          <option value="do not contact">do not contact</option>
        </select>
      </label>

      <label class="muted">Search
        <input id="searchInput" placeholder="Business, niche, city, caller email…" />
      </label>
    </div>

    <div class="table-wrap">
      <table id="leadsTable">
        <thead>
          <tr>
            <th>Business / Niche</th>
            <th>Contact</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Package</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <p id="leadsNote" class="muted" style="margin-top:8px;"></p>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>
      © <span id="year"></span> BrandCrafters — A division of Egyptian Hype LLC
      <a href="dashboard.html" class="admin-link">Admin</a>
    </div>
  </div>
</footer>
<script>
  document.getElementById('year').textContent = new Date().getFullYear();
</script>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL  = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const ADMIN_EMAIL   = "srarnold216@gmail.com";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  const userEmailSpan   = document.getElementById("userEmail");
  const logoutBtn       = document.getElementById("logoutBtn");
  const logoutBtnMobile = document.getElementById("logoutBtnMobile");

  const totalLeadsEl = document.getElementById("totalLeads");
  const openLeadsEl  = document.getElementById("openLeads");
  const wonLeadsEl   = document.getElementById("wonLeads");
  const lostLeadsEl  = document.getElementById("lostLeads");

  const statusFilter   = document.getElementById("statusFilter");
  const searchInput    = document.getElementById("searchInput");
  const leadsTableBody = document.querySelector("#leadsTable tbody");
  const leadsNote      = document.getElementById("leadsNote");

  let allLeads = [];

  async function guardAdmin() {
    const { data } = await supabaseClient.auth.getUser();
    if (!data || !data.user) {
      window.location.href = "dashboard.html";
      return null;
    }
    const email = data.user.email || "";
    userEmailSpan.textContent = email;
    if (email !== ADMIN_EMAIL) {
      window.location.href = "contractor-portal.html";
      return null;
    }
    return data.user;
  }

  async function doLogout() {
    await supabaseClient.auth.signOut();
    window.location.href = "dashboard.html";
  }
  logoutBtn?.addEventListener("click", doLogout);
  logoutBtnMobile?.addEventListener("click", doLogout);

  function isOpenStatus(s) {
    if (!s) return false;
    const v = s.toLowerCase();
    return ["new","in progress","follow up"].includes(v);
  }

  function isLostStatus(s) {
    if (!s) return false;
    const v = s.toLowerCase();
    return ["closed lost","do not contact"].includes(v);
  }

  function pillForStatus(status) {
    const s = (status || "new").toLowerCase();
    const span = document.createElement("span");
    if (s === "closed won") span.className = "pill pill-green";
    else if (isLostStatus(s)) span.className = "pill pill-red";
    else span.className = "pill pill-blue";
    span.textContent = s;
    return span;
  }

  function formatPhone(p) {
    if (!p) return "";
    return p;
  }

  function applyFilters() {
    const statusVal = statusFilter.value;
    const q = searchInput.value.trim().toLowerCase();

    let rows = [...allLeads];

    if (statusVal !== "all") {
      rows = rows.filter(ld => {
        const s = (ld.call_status || "new").toLowerCase();
        if (statusVal === "open") return isOpenStatus(s);
        return s === statusVal;
      });
    }

    if (q) {
      rows = rows.filter(ld => {
        const hay = [
          ld.business_name,
          ld.business,
          ld.niche,
          ld.category,
          ld.city,
          ld.state,
          ld.location,
          ld.assigned_caller_email,
          ld.finder_email
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    renderTable(rows);
  }

  function renderTable(leads) {
    leadsTableBody.innerHTML = "";
    if (!leads.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.className = "muted";
      td.textContent = "No leads match your filters.";
      tr.appendChild(td);
      leadsTableBody.appendChild(tr);
      leadsNote.textContent = "";
      return;
    }

    leads.forEach(ld => {
      const tr = document.createElement("tr");

      // Business / Niche
      const tdBiz = document.createElement("td");
      tdBiz.innerHTML =
        `<strong>${ld.business_name || ld.business || "(No name)"}</strong><br>` +
        `<span class="muted">${ld.niche || ld.category || ""}</span>`;
      tr.appendChild(tdBiz);

      // Contact
      const tdContact = document.createElement("td");
      const lines = [];
      if (ld.phone) lines.push(formatPhone(ld.phone));
      if (ld.email) lines.push(ld.email);
      const loc = ld.location || [ld.city, ld.state].filter(Boolean).join(", ");
      if (loc) lines.push(loc);
      tdContact.innerHTML = lines.join("<br>");
      tr.appendChild(tdContact);

      // Status
      const tdStatus = document.createElement("td");
      tdStatus.appendChild(pillForStatus(ld.call_status));
      tr.appendChild(tdStatus);

      // Assigned
      const tdAssigned = document.createElement("td");
      tdAssigned.innerHTML =
        `<div class="muted" style="font-size:12px;">` +
        (ld.assigned_caller_email || "Unassigned") +
        `</div>`;
      tr.appendChild(tdAssigned);

      // Package
      const tdPkg = document.createElement("td");
      const pkg = ld.recommended_package || ld.package_target || "";
      const upsell = ld.recommended_upsells || ld.upsell_notes || "";
      tdPkg.innerHTML =
        (pkg ? `<strong>${pkg}</strong>` : "—") +
        (upsell ? `<br><span class="muted">${upsell}</span>` : "");
      tr.appendChild(tdPkg);

      // Actions
      const tdActions = document.createElement("td");

      // Status select
      const select = document.createElement("select");
      ["new","in progress","follow up","closed won","closed lost","do not contact"].forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if ((ld.call_status || "new").toLowerCase() === opt) o.selected = true;
        select.appendChild(o);
      });
      select.style.fontSize = "12px";
      select.style.marginBottom = "4px";
      select.addEventListener("change", async () => {
        await updateLead(ld.id, { call_status: select.value });
      });
      tdActions.appendChild(select);

      // Assign to email quick input
      const assignInput = document.createElement("input");
      assignInput.type = "email";
      assignInput.placeholder = "assign@caller.com";
      assignInput.value = ld.assigned_caller_email || "";
      assignInput.style.display = "block";
      assignInput.style.margin = "4px 0";
      assignInput.style.fontSize = "12px";
      assignInput.style.padding = "4px 6px";
      assignInput.style.borderRadius = "8px";
      assignInput.style.border = "1px solid rgba(255,255,255,.18)";
      assignInput.style.background = "rgba(20,18,32,.7)";
      assignInput.style.color = "inherit";
      tdActions.appendChild(assignInput);

      const assignBtn = document.createElement("button");
      assignBtn.className = "btn-small primary";
      assignBtn.textContent = "Assign";
      assignBtn.addEventListener("click", async () => {
        const email = assignInput.value.trim() || null;
        await updateLead(ld.id, { assigned_caller_email: email });
      });
      tdActions.appendChild(assignBtn);

      const clearBtn = document.createElement("button");
      clearBtn.className = "btn-small";
      clearBtn.textContent = "Clear";
      clearBtn.addEventListener("click", async () => {
        assignInput.value = "";
        await updateLead(ld.id, { assigned_caller_email: null });
      });
      tdActions.appendChild(clearBtn);

      tr.appendChild(tdActions);
      leadsTableBody.appendChild(tr);
    });

    leadsNote.textContent = `${leads.length} lead(s) shown.`;
  }

  async function updateLead(id, patch) {
    if (!id) return;
    const { error } = await supabaseClient
      .from("call_leads")
      .update(patch)
      .eq("id", id);
    if (error) {
      console.error("update lead error:", error);
    } else {
      // Refresh allLeads & re-apply filters
      await loadLeads();
    }
  }

  async function loadLeads() {
    const { data, error } = await supabaseClient
      .from("call_leads")
      .select("*")
      .order("created_at", { ascending:false });

    if (error) {
      console.error("call_leads error:", error);
      leadsNote.textContent = "Error loading leads. Check console.";
      return;
    }

    allLeads = data || [];

    // Stats
    const total = allLeads.length;
    const open  = allLeads.filter(ld => isOpenStatus(ld.call_status)).length;
    const won   = allLeads.filter(ld => (ld.call_status || "").toLowerCase() === "closed won").length;
    const lost  = allLeads.filter(ld => isLostStatus(ld.call_status)).length;

    totalLeadsEl.textContent = total;
    openLeadsEl.textContent  = open;
    wonLeadsEl.textContent   = won;
    lostLeadsEl.textContent  = lost;

    applyFilters();
  }

  statusFilter.addEventListener("change", applyFilters);
  searchInput.addEventListener("input", () => {
    // small debounce is overkill; just re-filter on each input
    applyFilters();
  });

  (async () => {
    const user = await guardAdmin();
    if (!user) return;
    await loadLeads();
  })();
</script>
</body>
</html>
