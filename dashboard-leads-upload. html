<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters â€” Upload Leads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="dashboard.css" />
  <script defer src="dashboard.js"></script>
</head>

<body class="admin-body">

<!-- ============================
   HEADER (same as main site)
=============================== -->
<header class="site-header admin-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <nav class="nav desktop-nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="nav-link">Customer Portal</a>

      <span id="userEmail" class="admin-email"></span>
      <button id="logoutBtn" class="btn btn-outline">Logout</button>
    </nav>

    <button class="menu-toggle">
      <span></span><span></span><span></span>
    </button>
  </div>

  <nav class="mobile-drawer admin-drawer">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close">âœ•</button>
    </div>

    <a class="drawer-link" href="dashboard.html">Dashboard</a>
    <a class="drawer-link highlight" href="dashboard-leads-upload.html">Upload Leads</a>
    <a class="drawer-link" href="dashboard-leads.html">Lead List</a>
    <a class="drawer-link" href="dashboard-demos.html">Demo Library</a>
    <a class="drawer-link" href="dashboard-communications.html">Scripts</a>
    <a class="drawer-link" href="dashboard-settings.html">Settings</a>
    <button class="drawer-link" id="logoutBtnMobile">Logout</button>
  </nav>

  <div class="drawer-backdrop"></div>
</header>




<!-- ============================
   SIDEBAR
=============================== -->
<aside class="sidebar">
  <div class="sidebar-header">
    <div class="bc-icon">BC</div>
    <span class="sidebar-title">Admin Panel</span>
  </div>

  <nav class="sidebar-nav">
    <a href="dashboard.html" class="side-item">ğŸ  Dashboard</a>

    <div class="side-group">
      <div class="side-label">LEADS</div>
      <a href="dashboard-leads.html" class="side-sub">ğŸ“‡ Lead List</a>
      <a href="dashboard-leads-upload.html" class="side-sub active">ğŸ“¤ Upload CSV</a>
    </div>

    <div class="side-group">
      <div class="side-label">DEMOS</div>
      <a href="dashboard-demos.html" class="side-sub">ğŸŒ Demo Library</a>
    </div>

    <div class="side-group">
      <div class="side-label">COMMUNICATIONS</div>
      <a href="dashboard-communications.html" class="side-sub">ğŸ“ Scripts</a>
      <a href="dashboard-communications.html#email" class="side-sub">âœ‰ï¸ Emails</a>
      <a href="dashboard-communications.html#dm" class="side-sub">ğŸ’¬ DM Templates</a>
    </div>

    <div class="side-group">
      <div class="side-label">SETTINGS</div>
      <a href="dashboard-settings.html" class="side-sub">âš™ï¸ System Settings</a>
    </div>
  </nav>
</aside>




<!-- ============================
   MAIN CONTENT â€” CSV + Add/Edit
=============================== -->
<main class="main-content">
  <h1>Upload or Add Leads</h1>
  <p class="subhead">
    Upload CSV files or manually add/edit leads. Editing automatically applies if ?edit={id}.
  </p>

  <!-- CSV upload -->
  <section class="card" style="margin-bottom:25px;">
    <h2>Upload CSV</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <button class="btn btn-primary" style="margin-top:12px;" onclick="uploadCSV()">Upload CSV</button>
    <p id="csvMsg" class="muted"></p>
  </section>

  <!-- Manual add/edit -->
  <section class="card">
    <h2 id="formTitle">Add Lead</h2>

    <form id="leadForm" onsubmit="saveLead(event)">
      <input type="hidden" id="editId" />

      <label>Business Name
        <input id="business_name" required />
      </label>

      <label>Phone
        <input id="phone" />
      </label>

      <label>Email
        <input id="email" />
      </label>

      <label>Alternate Email
        <input id="alt_email" />
      </label>

      <label>Social / IG / FB
        <input id="social" />
      </label>

      <label>Category
        <input id="category" placeholder="Restaurant, Barber, Lawn Careâ€¦" />
      </label>

      <label>City / Location
        <input id="city" />
      </label>

      <label>Recommended Package
        <select id="package_recommendation">
          <option>Starter Craft</option>
          <option>Business Builder</option>
          <option>E-Commerce</option>
          <option>Dashboard Client</option>
        </select>
      </label>

      <label>Status
        <select id="call_status">
          <option value="new">New</option>
          <option value="working">Working</option>
          <option value="awaiting reply">Awaiting Reply</option>
          <option value="failed">Failed</option>
          <option value="closed won">Closed Won</option>
          <option value="closed lost">Closed Lost</option>
        </select>
      </label>

      <label>Assign Caller
        <input id="assigned_caller_email" placeholder="caller@example.com" />
      </label>

      <label>Mockup Requested?
        <select id="mockup_requested">
          <option value="false">No</option>
          <option value="true">Yes</option>
        </select>
      </label>

      <button class="btn btn-primary" type="submit" style="margin-top:16px;">Save Lead</button>
      <p id="formMsg" class="muted"></p>
    </form>
  </section>
</main>



<!-- ============================
   SUPABASE SCRIPT
=============================== -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
const ADMIN_EMAIL = "srarnold216@gmail.com";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


/* =============================
   AUTH GUARD
============================= */
async function guard(){
  const { data } = await db.auth.getUser();
  if (!data.user) return location.href="dashboard-login.html";

  if (data.user.email !== ADMIN_EMAIL) {
    location.href = "contractor-portal.html";
  }

  document.getElementById("userEmail").textContent = data.user.email;
}
guard();



/* =============================
   CSV UPLOAD
============================= */
function uploadCSV(){
  const file = document.getElementById("csvFile").files[0];
  if (!file) return alert("Choose a CSV file first.");

  const reader = new FileReader();
  reader.onload = async function(){
    const lines = reader.result.split("\n").map(l => l.trim()).filter(l => l);
    const headers = lines[0].split(",");

    let inserted = 0;
    for (let i=1;i<lines.length;i++){
      const row = lines[i].split(",");
      let obj = {};

      headers.forEach((h, idx)=>{
        obj[h.trim()] = row[idx]?.trim() || null;
      });

      const res = await db.from("call_leads").insert(obj);
      if (!res.error) inserted++;
    }

    document.getElementById("csvMsg").textContent = `${inserted} leads uploaded.`;
  };

  reader.readAsText(file);
}



/* =============================
   LOAD FOR EDITING
============================= */
async function loadEdit(){
  const params = new URLSearchParams(location.search);
  const id = params.get("edit");
  if (!id) return;

  document.getElementById("formTitle").textContent = "Edit Lead";
  document.getElementById("editId").value = id;

  const res = await db.from("call_leads").select("*").eq("id",id).single();
  if (!res.data) return;

  const L = res.data;
  document.getElementById("business_name").value = L.business_name||"";
  document.getElementById("phone").value = L.phone||"";
  document.getElementById("email").value = L.email||"";
  document.getElementById("alt_email").value = L.alt_email||"";
  document.getElementById("social").value = L.social||"";
  document.getElementById("category").value = L.category||"";
  document.getElementById("city").value = L.city||"";
  document.getElementById("package_recommendation").value = L.package_recommendation||"Starter Craft";
  document.getElementById("call_status").value = L.call_status||"new";
  document.getElementById("assigned_caller_email").value = L.assigned_caller_email||"";
  document.getElementById("mockup_requested").value = L.mockup_requested ? "true":"false";
}

loadEdit();



/* =============================
   SAVE LEAD
============================= */
async function saveLead(e){
  e.preventDefault();

  const id = document.getElementById("editId").value;
  const body = {
    business_name: document.getElementById("business_name").value,
    phone: document.getElementById("phone").value,
    email: document.getElementById("email").value,
    alt_email: document.getElementById("alt_email").value,
    social: document.getElementById("social").value,
    category: document.getElementById("category").value,
    city: document.getElementById("city").value,
    package_recommendation: document.getElementById("package_recommendation").value,
    call_status: document.getElementById("call_status").value,
    assigned_caller_email: document.getElementById("assigned_caller_email").value,
    mockup_requested: (document.getElementById("mockup_requested").value==="true")
  };

  let res;
  if (id){
    res = await db.from("call_leads").update(body).eq("id",id);
  } else {
    res = await db.from("call_leads").insert(body);
  }

  if (res.error) {
    document.getElementById("formMsg").textContent = "Error saving lead.";
  } else {
    document.getElementById("formMsg").textContent = "Saved!";
    setTimeout(()=> location.href="dashboard-leads.html", 600);
  }
}
</script>

</body>
</html>
