<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrandCrafters — Contractor Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <style>
    body{
      background:
        radial-gradient(1200px 600px at -10% -10%, #18122f 0, rgba(24,18,47,0) 60%),
        #050713;
      color:#f5f5ff;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    .portal-wrap{
      max-width:1100px;
      margin:24px auto 60px;
      padding:0 20px;
    }
    .portal-header{
      margin-bottom:18px;
    }
    .portal-header h1{
      margin:0 0 6px;
      font-size:24px;
    }
    .portal-header .subhead{
      margin:0;
      font-size:13px;
      color:#b5b7d8;
    }
    .portal-grid{
      display:grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap:16px;
      align-items:flex-start;
    }
    @media (max-width: 900px){
      .portal-grid{ grid-template-columns:1fr; }
    }
    .portal-card{
      background:rgba(255,255,255,.04);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      padding:16px 14px;
    }
    .portal-card h2{
      margin:0 0 8px;
      font-size:16px;
    }
    .small-muted{
      font-size:12px;
      color:#b5b7d8;
      margin:0 0 8px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:6px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#a4a6c4;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(110,168,255,.15);
      color:#dce6ff;
    }
    .badge-priority-a{background:rgba(115,255,193,.18);}
    .badge-priority-b{background:rgba(255,230,165,.18);}
    .badge-priority-c{background:rgba(255,173,173,.18);}
    .badge-status-new{background:rgba(110,168,255,.18);}
    .badge-status-in-progress{background:rgba(255,230,165,.18);}
    .badge-status-closed-won{background:rgba(115,255,193,.18);}
    .badge-status-closed-lost{background:rgba(255,173,173,.18);}
    .pill-channel{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.25);
      margin-right:4px;
    }
    .pill-package{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(110,168,255,.16);
      margin-left:4px;
    }
    .script-body{
      font-size:12px;
      white-space:pre-wrap;
      max-height:160px;
      overflow:auto;
      background:rgba(0,0,0,.2);
      border-radius:10px;
      padding:8px 10px;
      margin-top:6px;
    }
    .scripts-tabs{
      display:flex;
      gap:8px;
      margin:6px 0 10px;
      flex-wrap:wrap;
    }
    .scripts-tab-btn{
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.04);
      color:#f5f5ff;
      cursor:pointer;
    }
    .scripts-tab-btn.active{
      background:linear-gradient(135deg,#6ea8ff,#b166ff);
      border-color:transparent;
      color:#050713;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .pricing-note{
      margin-bottom:10px;
      padding:10px 10px;
      border-radius:12px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      font-size:12px;
    }
    .pricing-note h3{
      margin:0 0 4px;
      font-size:13px;
    }
    .pricing-note pre{
      margin:0;
      white-space:pre-wrap;
      font-family:inherit;
      color:#dfe3ff;
    }
    .portal-top-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    .portal-user{
      font-size:12px;
      color:#b5b7d8;
      text-align:right;
    }
    .empty-msg{
      font-size:12px;
      color:#b5b7d8;
      margin-top:6px;
    }
  </style>
  <script defer src="script.js"></script>
</head>
<body>
<!-- Header reused from index.html with Contractor Portal button -->
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <!-- Desktop Nav -->
    <nav class="nav desktop-nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="btn btn-outline">Customer Portal</a>
      <a href="contractor-portal.html" class="btn btn-primary">Contractor Portal</a>
    </nav>

    <!-- Mobile: Hamburger -->
    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <!-- Mobile Drawer (V8) -->
  <nav class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close" aria-label="Close menu">✕</button>
    </div>
    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>
    <a class="drawer-link highlight" href="contractor-portal.html">Contractor Portal</a>
  </nav>
  <div class="drawer-backdrop" aria-hidden="true"></div>
</header>

<main class="portal-wrap">
  <div class="portal-header">
    <div class="portal-top-bar">
      <div>
        <h1>Contractor Portal</h1>
        <p class="subhead">
          View leads, scripts, and pricing in one place while you call, email, or DM.
        </p>
      </div>
      <div class="portal-user" id="portalUserInfo">Checking login…</div>
    </div>
  </div>

  <section id="portalContent" style="display:none;">
    <div class="portal-grid">
      <!-- LEFT: LEADS -->
      <article class="portal-card">
        <h2>Leads</h2>
        <p class="small-muted">
          Admin sees all leads. Contractors see their assigned leads and unassigned leads.
        </p>
        <table id="leadsTable">
          <thead>
            <tr>
              <th>Business</th>
              <th>Phone</th>
              <th>Priority</th>
              <th>Status</th>
              <th>City</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div id="leadsEmpty" class="empty-msg" style="display:none;">
          No leads yet. Ask admin to assign or upload leads.
        </div>
      </article>

      <!-- RIGHT: SCRIPTS & PRICING -->
      <article class="portal-card">
        <h2>Scripts &amp; Pricing</h2>
        <p class="small-muted">
          This pulls from the scripts &amp; pricing CSV (outreach_templates).
        </p>

        <div id="pricingBlock"></div>

        <div class="scripts-tabs">
          <button class="scripts-tab-btn active" data-type="call">Call Scripts</button>
          <button class="scripts-tab-btn" data-type="email">Email Templates</button>
          <button class="scripts-tab-btn" data-type="dm">DM / Social Messages</button>
        </div>

        <div id="scriptsList"></div>
        <div id="scriptsEmpty" class="empty-msg" style="display:none;">
          No scripts uploaded yet. Ask admin to upload the scripts CSV.
        </div>
      </article>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>
      © <span id="year"></span> BrandCrafters — A division of Egyptian Hype LLC
    </div>
  </div>
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();
</script>

<!-- Supabase logic -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const ADMIN_EMAIL = "srarnold216@gmail.com";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const portalUserInfo = document.getElementById("portalUserInfo");
  const portalContent  = document.getElementById("portalContent");
  const leadsTableBody = document.querySelector("#leadsTable tbody");
  const leadsEmpty     = document.getElementById("leadsEmpty");
  const pricingBlock   = document.getElementById("pricingBlock");
  const scriptsList    = document.getElementById("scriptsList");
  const scriptsEmpty   = document.getElementById("scriptsEmpty");
  const tabButtons     = document.querySelectorAll(".scripts-tab-btn");

  let templatesCache = [];
  let currentScriptType = "call";
  let isAdminUser = false;

  function setPortalStatus(msg){
    portalUserInfo.textContent = msg;
  }

  function priorityBadge(p) {
    const val = (p || "").toString().toUpperCase();
    const span = document.createElement("span");
    span.classList.add("badge");
    if (val === "A") span.classList.add("badge-priority-a");
    else if (val === "B") span.classList.add("badge-priority-b");
    else span.classList.add("badge-priority-c");
    span.textContent = val || "-";
    return span;
  }

  function statusBadge(s) {
    const val = (s || "new").toLowerCase();
    const span = document.createElement("span");
    span.classList.add("badge");
    if (val === "in progress") span.classList.add("badge-status-in-progress");
    else if (val === "closed won") span.classList.add("badge-status-closed-won");
    else if (val === "closed lost") span.classList.add("badge-status-closed-lost");
    else span.classList.add("badge-status-new");
    span.textContent = val;
    return span;
  }

  async function guardUser() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) {
      console.error("Auth error:", error);
      setPortalStatus("Auth error. Try logging in again from your main dashboard.");
      return null;
    }
    if (!data || !data.user) {
      setPortalStatus("Not logged in. Log in from your BrandCrafters admin/login first.");
      return null;
    }

    const email = data.user.email || "";
    isAdminUser = (email === ADMIN_EMAIL);

    if (isAdminUser) {
      setPortalStatus("Admin · Full view");
    } else {
      setPortalStatus("Contractor: " + email);
    }

    portalContent.style.display = "block";
    return data.user;
  }

  async function loadLeads(email) {
    let query = supabaseClient.from("call_leads").select("*");

    if (isAdminUser) {
      // Admin: see everything
      query = query.order("priority", { ascending: true })
                   .order("created_at", { ascending: false })
                   .limit(100);
    } else {
      // Contractor: only their leads + unassigned
      query = query
        .or(`assigned_caller_email.eq.${email},assigned_caller_email.is.null`)
        .order("priority", { ascending: true })
        .order("created_at", { ascending: false })
        .limit(50);
    }

    const { data, error } = await query;

    if (error) {
      console.error("loadLeads error:", error);
      leadsEmpty.style.display = "block";
      leadsEmpty.textContent = "Error loading leads: " + error.message;
      return;
    }

    const leads = data || [];
    leadsTableBody.innerHTML = "";

    if (!leads.length) {
      leadsEmpty.style.display = "block";
      return;
    }
    leadsEmpty.style.display = "none";

    leads.forEach(ld => {
      const tr = document.createElement("tr");

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${ld.business_name || "(No name)"}</strong><br><span class="small-muted">${ld.email || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = ld.phone || "";
      tr.appendChild(tdPhone);

      const tdPriority = document.createElement("td");
      tdPriority.appendChild(priorityBadge(ld.priority));
      tr.appendChild(tdPriority);

      const tdStatus = document.createElement("td");
      tdStatus.appendChild(statusBadge(ld.call_status));
      tr.appendChild(tdStatus);

      const tdCity = document.createElement("td");
      tdCity.textContent = (ld.city || "") + (ld.state ? ", " + ld.state : "");
      tr.appendChild(tdCity);

      leadsTableBody.appendChild(tr);
    });
  }

  async function loadTemplates() {
    const { data, error } = await supabaseClient
      .from("outreach_templates")
      .select("*")
      .eq("is_active", true)
      .order("priority", { ascending: true })
      .order("created_at", { ascending: false });

    if (error) {
      console.error("loadTemplates error:", error);
      scriptsEmpty.style.display = "block";
      scriptsEmpty.textContent = "Error loading scripts: " + error.message;
      return;
    }

    templatesCache = data || [];
    renderPricing();
    renderScripts(currentScriptType);
  }

  function renderPricing() {
    pricingBlock.innerHTML = "";
    const infos = templatesCache.filter(t => (t.template_type || "").toLowerCase() === "info");

    if (!infos.length) {
      const div = document.createElement("div");
      div.className = "pricing-note";
      div.innerHTML = "<h3>Pricing Overview</h3><pre>Ask admin to upload the scripts & pricing CSV.</pre>";
      pricingBlock.appendChild(div);
      return;
    }

    infos.forEach(t => {
      const div = document.createElement("div");
      div.className = "pricing-note";
      const title = document.createElement("h3");
      title.textContent = t.title || "Info";
      const body = document.createElement("pre");
      body.textContent = t.body || "";
      div.appendChild(title);
      div.appendChild(body);
      pricingBlock.appendChild(div);
    });
  }

  function renderScripts(type) {
    scriptsList.innerHTML = "";

    const filtered = templatesCache.filter(t => {
      return (t.template_type || "").toLowerCase() === type;
    });

    if (!filtered.length) {
      scriptsEmpty.style.display = "block";
      return;
    }
    scriptsEmpty.style.display = "none";

    filtered.forEach(t => {
      const wrapper = document.createElement("div");
      wrapper.style.marginBottom = "10px";
      wrapper.style.borderBottom = "1px solid rgba(255,255,255,.08)";
      wrapper.style.paddingBottom = "8px";

      const titleRow = document.createElement("div");
      titleRow.style.display = "flex";
      titleRow.style.justifyContent = "space-between";
      titleRow.style.alignItems = "center";
      titleRow.style.gap = "6px";

      const leftTitle = document.createElement("div");
      leftTitle.style.fontSize = "13px";
      leftTitle.style.fontWeight = "600";
      leftTitle.textContent = t.title || "(Untitled)";

      const rightChips = document.createElement("div");

      if (t.channel) {
        const ch = document.createElement("span");
        ch.className = "pill-channel";
        ch.textContent = t.channel;
        rightChips.appendChild(ch);
      }
      if (t.target_package) {
        const pkg = document.createElement("span");
        pkg.className = "pill-package";
        pkg.textContent = t.target_package;
        rightChips.appendChild(pkg);
      }

      titleRow.appendChild(leftTitle);
      titleRow.appendChild(rightChips);

      const body = document.createElement("div");
      body.className = "script-body";
      body.textContent = t.body || "";

      wrapper.appendChild(titleRow);
      wrapper.appendChild(body);

      scriptsList.appendChild(wrapper);
    });
  }

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const type = btn.getAttribute("data-type");
      currentScriptType = type;
      renderScripts(type);
    });
  });

  (async () => {
    const user = await guardUser();
    if (!user) return;
    const email = user.email || "";
    await Promise.all([
      loadLeads(email),
      loadTemplates()
    ]);
  })();
</script>
</body>
</html>
