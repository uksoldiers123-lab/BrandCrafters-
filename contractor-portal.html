<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Contractor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#050713;
      --panel:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.08);
      --text:#f5f5ff;
      --muted:#b5b7d8;
      --grad:linear-gradient(135deg,#6ea8ff,#b166ff);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #18122f 0, rgba(24,18,47,0) 60%),
        var(--bg);
      color:var(--text);
    }
    a{text-decoration:none;color:var(--text);}
    header{
      position:sticky;top:0;z-index:40;
      background:rgba(5,7,19,.95);
      backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:14px;
    }
    .logo-mark{
      display:inline-grid;
      place-items:center;
      width:32px;
      height:32px;
      border-radius:12px;
      background:var(--grad);
      color:#050713;
      font-weight:800;
      font-size:14px;
    }
    .brand-sub{
      font-size:12px;
      color:var(--muted);
    }
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .nav a{
      font-size:13px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.04);
      text-decoration:none;
      color:var(--text);
      transition:.18s;
    }
    .nav a.primary{
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .nav a:hover{
      background:rgba(255,255,255,.10);
      transform:translateY(-1px);
    }
    .nav a.primary:hover{
      filter:brightness(1.05);
    }
    .user-email{font-size:12px;color:var(--muted);}
    .logout-btn{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,.5);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(110,168,255,.3);
      transition:.18s;
    }
    .logout-btn:hover{
      background:rgba(255,255,255,.16);
      transform:translateY(-1px);
    }

    main{
      max-width:1100px;margin:18px auto 60px;
      padding:0 16px;
    }
    h1{margin:0 0 6px;font-size:22px;}
    .subhead{margin:0 0 18px;font-size:13px;color:var(--muted);}
    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:16px 14px;
      margin-bottom:16px;
    }
    .card h2{margin:0 0 8px;font-size:16px;}
    .card p{margin:0 0 6px;font-size:13px;}
    .small{font-size:12px;color:var(--muted);}
    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px;}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:5px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
    }
    .status-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(110,168,255,.15);
    }
    .status-pill.new{background:rgba(111,255,193,.15);}
    .status-pill.working{background:rgba(255,230,150,.2);}
    .status-pill.closedwon{background:rgba(174,255,174,.2);}
    .status-pill.closedlost{background:rgba(255,164,164,.2);}
    .btn{
      display:inline-block;
      margin-top:4px;
      padding:6px 10px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:11px;
      font-weight:600;
      background:var(--grad);
      color:#050713;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .btn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    .center-msg{
      text-align:center;
      margin-top:40px;
      color:var(--muted);
      font-size:13px;
    }
    .hidden{display:none;}
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>
    <span class="brand-sub">Contractor Portal</span>
  </div>
  <div class="nav">
    <a href="dashboard.html">Admin Dashboard</a>
    <a href="dashboard-leads-upload.html">Leads &amp; CSV</a>
    <a href="contractor-portal.html" class="primary">Contractor Portal</a>
    <span class="user-email" id="userEmail"></span>
    <button id="logoutBtn" class="logout-btn" type="button">Log Out</button>
  </div>
</header>

<main>
  <section id="accessMessage" class="center-msg"></section>

  <section id="portalContent" class="hidden">
    <h1>Your Leads</h1>
    <p class="subhead">
      Assigned leads + unclaimed leads. When you click “Start Working”, that lead locks to you.
    </p>

    <article class="card">
      <h2>Assigned to You</h2>
      <p class="small">Leads already assigned to your email.</p>
      <table id="assignedTable">
        <thead>
          <tr>
            <th>Business</th>
            <th>Phone</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Last Contact</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </article>

    <article class="card">
      <h2>Unclaimed Leads</h2>
      <p class="small">
        These are shared leads. First caller to click “Start Working” claims it.
      </p>
      <table id="unclaimedTable">
        <thead>
          <tr>
            <th>Business</th>
            <th>Phone</th>
            <th>Priority</th>
            <th>City</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </article>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan    = document.getElementById("userEmail");
  const logoutBtn        = document.getElementById("logoutBtn");
  const accessMessage    = document.getElementById("accessMessage");
  const portalContent    = document.getElementById("portalContent");

  const assignedTableBody  = document.querySelector("#assignedTable tbody");
  const unclaimedTableBody = document.querySelector("#unclaimedTable tbody");

  function showMsg(text) {
    accessMessage.textContent = text;
  }
  function showPortal() {
    portalContent.classList.remove("hidden");
  }

  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s === "new") return "status-pill new";
    if (s === "working") return "status-pill working";
    if (s === "closed won") return "status-pill closedwon";
    if (s === "closed lost") return "status-pill closedlost";
    return "status-pill";
  }

  async function initPortal() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) {
      console.error("Auth error:", error);
      showMsg("Error checking login. Ask admin to log you in from the Admin Dashboard.");
      return;
    }
    if (!data || !data.user) {
      showMsg("Not signed in. Ask admin to log you in from the Admin Dashboard first.");
      return;
    }

    const email = data.user.email;
    userEmailSpan.textContent = email || "";
    showMsg("Signed in as " + (email || "unknown") + ".");

    showPortal();
    loadLeads(email);
  }

  logoutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    userEmailSpan.textContent = "";
    portalContent.classList.add("hidden");
    showMsg("Logged out. Ask admin to log you in again when ready to work.");
  });

  async function loadLeads(email) {
    const [assignedRes, unclaimedRes] = await Promise.all([
      supabaseClient
        .from("call_leads")
        .select("*")
        .eq("assigned_caller_email", email),
      supabaseClient
        .from("call_leads")
        .select("*")
        .is("assigned_caller_email", null)
    ]);

    if (assignedRes.error) console.error("Assigned error:", assignedRes.error);
    if (unclaimedRes.error) console.error("Unclaimed error:", unclaimedRes.error);

    const assigned = assignedRes.data || [];
    const unclaimed = unclaimedRes.data || [];

    // Assigned table
    assignedTableBody.innerHTML = "";
    assigned.forEach(ld => {
      const tr = document.createElement("tr");

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${ld.business_name || "(No name)"}</strong><br><span class="small">${ld.email || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = ld.phone || "";
      tr.appendChild(tdPhone);

      const tdPriority = document.createElement("td");
      tdPriority.textContent = (ld.priority || "").toUpperCase();
      tr.appendChild(tdPriority);

      const tdStatus = document.createElement("td");
      const spanS = document.createElement("span");
      spanS.className = statusClass(ld.call_status);
      spanS.textContent = (ld.call_status || "new");
      tdStatus.appendChild(spanS);
      tr.appendChild(tdStatus);

      const tdLast = document.createElement("td");
      tdLast.textContent = ld.last_contact_date || "";
      tr.appendChild(tdLast);

      assignedTableBody.appendChild(tr);
    });

    // Unclaimed table
    unclaimedTableBody.innerHTML = "";
    unclaimed.forEach(ld => {
      const tr = document.createElement("tr");

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${ld.business_name || "(No name)"}</strong><br><span class="small">${ld.email || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = ld.phone || "";
      tr.appendChild(tdPhone);

      const tdPriority = document.createElement("td");
      tdPriority.textContent = (ld.priority || "").toUpperCase();
      tr.appendChild(tdPriority);

      const tdCity = document.createElement("td");
      tdCity.textContent = ld.city || "";
      tr.appendChild(tdCity);

      const tdAction = document.createElement("td");
      const btn = document.createElement("button");
      btn.className = "btn";
      btn.textContent = "Start Working";
      btn.addEventListener("click", () => claimLead(ld.id, email));
      tdAction.appendChild(btn);
      tr.appendChild(tdAction);

      unclaimedTableBody.appendChild(tr);
    });
  }

  async function claimLead(id, email) {
    const { error } = await supabaseClient
      .from("call_leads")
      .update({
        assigned_caller_email: email,
        call_status: "working",
        last_contact_date: new Date().toISOString().slice(0,10)
      })
      .eq("id", id)
      .is("assigned_caller_email", null);

    if (error) {
      console.error("claimLead error:", error);
      alert("Could not claim lead. It might have been taken by another caller.");
      return;
    }

    loadLeads(email);
  }

  initPortal();
</script>
</body>
</html>
