<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Contractor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="dashboard.css" />
  <script defer src="dashboard.js"></script>
</head>

<body class="admin-body">

<!-- ============================
   HEADER (same as main site)
=============================== -->
<header class="site-header admin-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <nav class="nav desktop-nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="nav-link">Customer Portal</a>

      <span id="userEmail" class="admin-email"></span>
      <button id="logoutBtn" class="btn btn-outline">Logout</button>
    </nav>

    <button class="menu-toggle" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <nav class="mobile-drawer admin-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close">✕</button>
    </div>

    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>
    <a class="drawer-link highlight" href="contractor-portal.html">Contractor Portal</a>
    <button class="drawer-link" id="logoutBtnMobile">Logout</button>
  </nav>

  <div class="drawer-backdrop"></div>
</header>



<!-- ============================
   MAIN CONTENT
=============================== -->
<main class="main-content" style="max-width:1100px;margin-inline:auto;">
  <h1>Contractor Portal</h1>
  <p class="subhead">
    View and work your assigned leads, see demo sites, and use pre-made scripts & pricing.
  </p>

  <!-- SUMMARY STATS -->
  <section class="grid-3" style="margin-bottom:24px;">
    <div class="card stat-card">
      <div class="stat-label">My Active Leads</div>
      <div class="stat-value" id="statActiveLeads">0</div>
      <p class="muted">Leads you’re currently working.</p>
    </div>
    <div class="card stat-card">
      <div class="stat-label">Closed Won</div>
      <div class="stat-value" id="statClosedWon">0</div>
      <p class="muted">Closed deals under your email.</p>
    </div>
    <div class="card stat-card">
      <div class="stat-label">Max Open Allowed</div>
      <div class="stat-value" id="statMaxOpen">2</div>
      <p class="muted">Set by admin.</p>
    </div>
  </section>


  <!-- MY ACTIVE LEADS -->
  <section class="card" style="margin-bottom:24px;">
    <h2>My Active Leads</h2>
    <p class="muted">
      These are your leads. Update statuses honestly — they determine bonuses and future assignments.
    </p>

    <table class="table" id="myLeadsTable">
      <thead>
        <tr>
          <th>Business</th>
          <th>Contact</th>
          <th>Status</th>
          <th>Category</th>
          <th>Package Rec.</th>
          <th>Mockup?</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="myLeadsMsg" class="muted"></p>
  </section>


  <!-- AVAILABLE LEADS -->
  <section class="card" style="margin-bottom:24px;">
    <h2>Available Leads</h2>
    <p class="muted">
      You can only hold up to your max open leads at once. Claim carefully and work them fully.
    </p>

    <table class="table" id="availableLeadsTable">
      <thead>
        <tr>
          <th>Business</th>
          <th>Location</th>
          <th>Phone</th>
          <th>Category</th>
          <th>Package Rec.</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="availMsg" class="muted"></p>
  </section>


  <!-- DEMO LIBRARY (LIVE ONLY) -->
  <section class="card" style="margin-bottom:24px;">
    <h2>Demo Sites (Live)</h2>
    <p class="muted">
      Use these demo sites as examples when speaking with leads. Match by category when possible.
    </p>

    <table class="table" id="demoTable">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Link</th>
          <th>Notes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="muted" id="demoMsg"></p>
  </section>


  <!-- SCRIPTS & PRICING -->
  <section class="card" style="margin-bottom:24px;">
    <h2>Scripts & Pricing</h2>
    <p class="muted">
      Use these exact scripts or copy/paste messages. Pricing is pre-set — do not discount without approval.
    </p>

    <div class="grid-2" style="margin-top:10px;">
      <!-- Scripts -->
      <div>
        <h3>Call Scripts</h3>
        <div id="scriptList" class="script-list"></div>

        <h3 id="email">Email Templates</h3>
        <div id="emailList" class="script-list"></div>

        <h3 id="dm">DM / Social Templates</h3>
        <div id="dmList" class="script-list"></div>
      </div>

      <!-- Pricing -->
      <div>
        <h3>Pricing Cheat Sheet</h3>
        <table class="table">
          <thead>
            <tr><th>Package</th><th>Price</th><th>Commission*</th></tr>
          </thead>
          <tbody>
            <tr>
              <td>Starter Craft</td>
              <td>$249</td>
              <td id="commStarter">$50</td>
            </tr>
            <tr>
              <td>Business Builder</td>
              <td>$699</td>
              <td id="commBusiness">$75</td>
            </tr>
            <tr>
              <td>E-Commerce Store</td>
              <td>$1,199</td>
              <td id="commEcommerce">$100</td>
            </tr>
          </tbody>
        </table>
        <p class="muted" style="font-size:12px;">
          *Commission amounts are base and may change. Final payouts are confirmed in your monthly report.
        </p>

        <h4 style="margin-top:16px;">Maintenance / Add-Ons (for reference)</h4>
        <ul class="muted" style="font-size:13px;">
          <li>Maintenance (Lite / Standard / Pro / Commerce) — monthly</li>
          <li>Payment Link Setup — $50 per link</li>
          <li>Business Email — $75–$150 per mailbox</li>
          <li>Email Forwarding — $25</li>
          <li>SEO Setup — $125–$200</li>
          <li>Social Media Kit — $75–$150</li>
        </ul>
      </div>
    </div>
  </section>
</main>



<!-- ============================
   SUPABASE + PAGE LOGIC
=============================== -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIsInZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
const ADMIN_EMAIL = "srarnold216@gmail.com";

const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let maxOpenLeads = 2;

/* AUTH GUARD */
async function guard(){
  const { data } = await client.auth.getUser();
  if (!data.user){
    window.location.href = "dashboard-login.html";
    return;
  }
  // Admin should not use contractor portal
  if (data.user.email === ADMIN_EMAIL){
    window.location.href = "dashboard.html";
    return;
  }
  currentUser = data.user;
  document.getElementById("userEmail").textContent = currentUser.email;

  await loadSettings();
  await loadEverything();
}
guard();

/* SETTINGS (max open + commissions) */
async function loadSettings(){
  const res = await client.from("admin_settings").select("*").in("key", [
    "contractor_max_open_leads",
    "commission_starter",
    "commission_business",
    "commission_ecommerce"
  ]);
  if (res.error){
    console.error(res.error);
    return;
  }
  const map = {};
  (res.data || []).forEach(row => { map[row.key] = row.value; });

  maxOpenLeads = Number(map["contractor_max_open_leads"] || 2);
  document.getElementById("statMaxOpen").textContent = maxOpenLeads;

  if (map["commission_starter"])   document.getElementById("commStarter").textContent   = "$"+map["commission_starter"];
  if (map["commission_business"])  document.getElementById("commBusiness").textContent  = "$"+map["commission_business"];
  if (map["commission_ecommerce"]) document.getElementById("commEcommerce").textContent = "$"+map["commission_ecommerce"];
}

/* LOAD ALL MAIN DATA */
async function loadEverything(){
  await Promise.all([
    loadMyLeads(),
    loadAvailableLeads(),
    loadDemos(),
    loadTemplates()
  ]);
}

/* MY LEADS */
async function loadMyLeads(){
  if (!currentUser) return;
  const email = currentUser.email;

  const res = await client.from("call_leads")
    .select("*")
    .eq("assigned_caller_email", email)
    .order("created_at", { ascending:false });

  const data = res.data || [];
  const tbody = document.querySelector("#myLeadsTable tbody");
  tbody.innerHTML = "";

  let activeCount = 0;
  let closedWonCount = 0;

  data.forEach(L => {
    if (["closed won","closed lost","failed"].includes((L.call_status||"").toLowerCase())) {
      // Not active
    } else {
      activeCount++;
    }
    if ((L.call_status||"").toLowerCase() === "closed won") closedWonCount++;

    const status = (L.call_status || "new");

    tbody.innerHTML += `
      <tr>
        <td><strong>${L.business_name||"—"}</strong><br>
          <span class="muted">${L.city||""}</span>
        </td>
        <td>
          <div>${L.phone||"—"}</div>
          <div class="muted">${L.email||""}</div>
        </td>
        <td>
          <select onchange="updateStatus('${L.id}', this.value)">
            <option value="new" ${status==="new"?"selected":""}>New</option>
            <option value="working" ${status==="working"?"selected":""}>Working</option>
            <option value="awaiting reply" ${status==="awaiting reply"?"selected":""}>Awaiting Reply</option>
            <option value="failed" ${status==="failed"?"selected":""}>Failed</option>
            <option value="closed won" ${status==="closed won"?"selected":""}>Closed Won</option>
            <option value="closed lost" ${status==="closed lost"?"selected":""}>Closed Lost</option>
          </select>
        </td>
        <td>${L.category||"—"}</td>
        <td>${L.package_recommendation||"—"}</td>
        <td>
          <select onchange="toggleMockup('${L.id}', this.value)">
            <option value="false" ${!L.mockup_requested?"selected":""}>No</option>
            <option value="true" ${L.mockup_requested?"selected":""}>Suggest</option>
          </select>
        </td>
        <td>
          <button class="btn-small" onclick="releaseLead('${L.id}')">Release</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("statActiveLeads").textContent = activeCount;
  document.getElementById("statClosedWon").textContent = closedWonCount;
  document.getElementById("myLeadsMsg").textContent = data.length ? "" : "You do not have any leads assigned yet.";
}

/* AVAILABLE LEADS */
async function loadAvailableLeads(){
  const res = await client.from("call_leads")
    .select("*")
    .is("assigned_caller_email", null)
    .eq("call_status","new")
    .order("created_at",{ascending:false});

  const data = res.data || [];
  const tbody = document.querySelector("#availableLeadsTable tbody");
  tbody.innerHTML = "";

  data.forEach(L => {
    tbody.innerHTML += `
      <tr>
        <td><strong>${L.business_name||"—"}</strong></td>
        <td>${L.city||"—"}</td>
        <td>${L.phone||"—"}</td>
        <td>${L.category||"—"}</td>
        <td>${L.package_recommendation||"—"}</td>
        <td>
          <button class="btn-small" onclick="claimLead('${L.id}')">Claim</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("availMsg").textContent = data.length
    ? ""
    : "No unassigned new leads right now.";
}

/* CLAIM LEAD (respect max open) */
async function claimLead(id){
  if (!currentUser) return;
  const email = currentUser.email;

  // Count open leads
  const res = await client.from("call_leads")
    .select("id, call_status")
    .eq("assigned_caller_email", email);

  const myLeads = res.data || [];
  let openCount = 0;
  myLeads.forEach(L => {
    const st = (L.call_status||"").toLowerCase();
    if (!["closed won","closed lost","failed"].includes(st)) openCount++;
  });

  if (openCount >= maxOpenLeads){
    alert("You already have the maximum number of open leads. Close or release some before claiming more.");
    return;
  }

  const upd = await client.from("call_leads")
    .update({ assigned_caller_email: email, call_status: "working" })
    .eq("id", id)
    .is("assigned_caller_email", null); // only if still unassigned

  if (upd.error){
    console.error(upd.error);
    alert("Error claiming lead.");
  } else {
    loadEverything();
  }
}

/* RELEASE LEAD (back to pool) */
async function releaseLead(id){
  if (!confirm("Release this lead back to the pool?")) return;

  const upd = await client.from("call_leads")
    .update({
      assigned_caller_email: null,
      call_status: "new"
    })
    .eq("id", id);

  if (upd.error){
    console.error(upd.error);
    alert("Error releasing lead.");
  } else {
    loadEverything();
  }
}

/* UPDATE STATUS */
async function updateStatus(id, status){
  const upd = await client.from("call_leads")
    .update({ call_status: status })
    .eq("id", id);

  if (upd.error){
    console.error(upd.error);
    alert("Error updating status.");
  } else {
    loadMyLeads();
  }
}

/* MOCKUP FLAG */
async function toggleMockup(id, val){
  const upd = await client.from("call_leads")
    .update({ mockup_requested: (val==="true") })
    .eq("id", id);

  if (upd.error){
    console.error(upd.error);
    alert("Error updating mockup flag.");
  }
}

/* DEMO SITES (LIVE ONLY) */
async function loadDemos(){
  const res = await client.from("demo_sites")
    .select("*")
    .eq("is_active", true)
    .order("category",{ascending:true});

  const data = res.data || [];
  const tbody = document.querySelector("#demoTable tbody");
  tbody.innerHTML = "";

  data.forEach(d => {
    const shortUrl = d.demo_url
      ? (d.demo_url.length > 40 ? d.demo_url.slice(0,37) + "..." : d.demo_url)
      : "—";

    tbody.innerHTML += `
      <tr>
        <td><strong>${d.name}</strong></td>
        <td>${d.category || "—"}</td>
        <td>${d.demo_url ? `<a href="${d.demo_url}" target="_blank" class="muted">${shortUrl}</a>` : "—"}</td>
        <td class="muted">${d.notes || ""}</td>
      </tr>
    `;
  });

  document.getElementById("demoMsg").textContent = data.length
    ? ""
    : "No live demos yet. Admin adds these from the Demo Library.";
}

/* SCRIPTS & TEMPLATES */
async function loadTemplates(){
  const res = await client.from("communication_templates")
    .select("*")
    .eq("is_active", true)
    .order("created_at",{ascending:false});

  const data = res.data || [];
  const scriptDiv = document.getElementById("scriptList");
  const emailDiv  = document.getElementById("emailList");
  const dmDiv     = document.getElementById("dmList");

  scriptDiv.innerHTML = "";
  emailDiv.innerHTML  = "";
  dmDiv.innerHTML     = "";

  data.forEach(t => {
    const block = `
      <div class="template-block">
        <div class="template-title">${t.title}</div>
        <pre class="template-body">${(t.content || "").replace(/</g,"&lt;")}</pre>
      </div>
    `;

    if (t.type === "script"){
      scriptDiv.innerHTML += block;
    } else if (t.type === "email"){
      emailDiv.innerHTML += block;
    } else if (t.type === "dm"){
      dmDiv.innerHTML += block;
    }
  });

  if (!scriptDiv.innerHTML) scriptDiv.innerHTML = `<p class="muted">No call scripts yet.</p>`;
  if (!emailDiv.innerHTML)  emailDiv.innerHTML  = `<p class="muted">No email templates yet.</p>`;
  if (!dmDiv.innerHTML)     dmDiv.innerHTML     = `<p class="muted">No DM templates yet.</p>`;
}
</script>

</body>
</html>
