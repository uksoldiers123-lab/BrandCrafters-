<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters ‚Äî Contractor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#050713;
      --panel:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.08);
      --text:#f5f5ff;
      --muted:#b5b7d8;
      --primary:#6ea8ff;
      --accent:#d16de1;
      --grad:linear-gradient(135deg,#5b8cff,#b166ff 60%,#ff6ad6);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #18122f 0, rgba(24,18,47,0) 60%),
        var(--bg);
      color:var(--text);
    }
    a{text-decoration:none;color:inherit;}

    .container{max-width:1100px;margin:0 auto;padding:0 20px;}

    /* HEADER styled like index */
    .site-header{
      position:sticky;
      top:0;
      z-index:40;
      background:rgba(5,7,19,.95);
      backdrop-filter:blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .header-inner{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo-mark{
      display:inline-grid;
      place-items:center;
      width:34px;
      height:34px;
      border-radius:12px;
      background:var(--grad);
      color:#050713;
      font-weight:800;
      font-size:18px;
    }
    .logo span:last-child{
      font-size:15px;
    }

    .nav{
      display:flex;
      align-items:center;
      gap:14px;
      font-size:13px;
    }
    .nav-link{
      position:relative;
      padding:8px 10px;
      border-radius:999px;
      text-decoration:none;
      color:var(--text);
      transition:.18s;
    }
    .nav-link:hover{
      background:rgba(255,255,255,.06);
    }
    .nav-link.active{
      background:rgba(255,255,255,.10);
      box-shadow:0 0 0 1px rgba(255,255,255,.18);
    }
    .nav-link.subtle{
      color:var(--muted);
    }

    .user-pill{
      font-size:11px;
      color:var(--muted);
      max-width:190px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn-logout{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,.6);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-size:11px;
      cursor:pointer;
      transition:.18s;
    }
    .btn-logout:hover{
      background:rgba(255,255,255,.14);
      transform:translateY(-1px);
    }

    /* MAIN LAYOUT */
    main{
      padding:20px 0 60px;
    }
    h1{margin:0 0 6px;font-size:22px;}
    h2{margin:0 0 8px;font-size:16px;}
    .subhead{margin:0 0 18px;font-size:13px;color:var(--muted);}
    .small{font-size:12px;color:var(--muted);}

    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:16px 14px;
      box-shadow:0 18px 40px rgba(0,0,0,.6);
      margin-bottom:16px;
    }

    .grid-3{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
    }
    .grid-2{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px;
    }
    @media(max-width:880px){
      .grid-3{grid-template-columns:1fr;}
      .grid-2{grid-template-columns:1fr;}
      .nav{gap:8px;}
    }

    .stat-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
    }
    .stat-value{
      font-size:20px;
      font-weight:700;
      margin-top:4px;
    }
    .stat-sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
    }
    .pill-green{background:rgba(155,255,191,.18);}
    .pill-yellow{background:rgba(255,218,155,.18);}
    .pill-blue{background:rgba(110,168,255,.18);}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:5px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
    }

    .btn{
      display:inline-block;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:600;
      border:0;
      cursor:pointer;
      transition:.18s;
    }
    .btn-primary{
      background:var(--grad);
      color:#050713;
    }
    .btn-ghost{
      background:rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid rgba(255,255,255,.18);
    }
    .btn-small{
      padding:4px 8px;
      font-size:11px;
    }
    .btn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .tab-btn{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.04);
      font-size:12px;
      cursor:pointer;
      transition:.18s;
    }
    .tab-btn.active{
      background:var(--grad);
      color:#050713;
      border-color:transparent;
    }

    #leadsSection,
    #scriptsSection{display:none;}
    #leadsSection.active,
    #scriptsSection.active{display:block;}

    .tag{
      display:inline-block;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      padding:2px 7px;
      font-size:11px;
      margin-right:4px;
      margin-bottom:4px;
    }
    textarea{
      width:100%;
      min-height:70px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(5,7,19,.9);
      color:var(--text);
      font-size:12px;
      padding:8px 10px;
      resize:vertical;
    }
    select{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(5,7,19,.9);
      color:var(--text);
      font-size:12px;
      padding:4px 8px;
    }
    input[type="text"]{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(5,7,19,.9);
      color:var(--text);
      font-size:12px;
      padding:6px 10px;
      width:100%;
    }
    .code-block{
      background:rgba(0,0,0,.6);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      line-height:1.5;
      overflow-x:auto;
      margin-top:6px;
    }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a href="index.html" class="logo">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <nav class="nav">
      <a href="index.html" class="nav-link subtle">Home</a>
      <a href="pricing.html" class="nav-link subtle">Pricing</a>
      <a href="contractor-portal.html" class="nav-link active">Contractor Portal</a>
      <span id="userEmail" class="user-pill"></span>
      <button id="logoutBtn" class="btn-logout">Log Out</button>
    </nav>
  </div>
</header>

<main class="container">
  <section style="margin-top:18px;">
    <h1>Contractor Portal</h1>
    <p class="subhead">
      Work your assigned leads, claim new ones, and use the scripts & pricing below. Close websites = get paid.
    </p>
  </section>

  <!-- TOP STATS -->
  <section class="grid-3">
    <article class="card">
      <div class="stat-label">My Active Leads</div>
      <div class="stat-value" id="myActiveLeads">0</div>
      <div class="stat-sub">Assigned to you with status not closed.</div>
    </article>
    <article class="card">
      <div class="stat-label">My Closed Won</div>
      <div class="stat-value" id="myClosedWon">0</div>
      <div class="stat-sub">Total leads you closed as paid website clients.</div>
    </article>
    <article class="card">
      <div class="stat-label">Est. Commission</div>
      <div class="stat-value" id="myCommission">$0.00</div>
      <div class="stat-sub">$100 per closed website (non-add-on only).</div>
    </article>
  </section>

  <!-- TABS -->
  <section class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="leadsSection">Leads</button>
      <button class="tab-btn" data-tab="scriptsSection">Scripts & Pricing</button>
    </div>

    <!-- LEADS TAB -->
    <div id="leadsSection" class="active">
      <div class="grid-2" style="margin-bottom:12px;">
        <div>
          <p class="small">
            You‚Äôll see:
            <br>‚Ä¢ Unassigned leads (you can claim them)
            <br>‚Ä¢ Leads already assigned to you
          </p>
        </div>
        <div style="text-align:right;">
          <label class="small">
            Filter by status:
            <select id="statusFilter">
              <option value="all">All</option>
              <option value="new">New</option>
              <option value="working">Working</option>
              <option value="no answer">No Answer</option>
              <option value="not interested">Not Interested</option>
              <option value="closed won">Closed Won</option>
            </select>
          </label>
        </div>
      </div>

      <div style="max-height:420px;overflow:auto;">
        <table id="leadsTable">
          <thead>
            <tr>
              <th>Business</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Last Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small" id="leadsNote" style="margin-top:8px;"></p>
    </div>

    <!-- SCRIPTS TAB -->
    <div id="scriptsSection">
      <div class="grid-2">
        <article class="card" style="margin-bottom:0;">
          <h2>Phone Script (Cold Call)</h2>
          <p class="small">Use this to open, qualify, and pitch BrandCrafters websites.</p>
          <div class="code-block">
            <strong>Intro</strong><br>
            ‚ÄúHi, is this <em>[Business Name]</em>? Hey, my name is <em>[Your Name]</em>, I work with a small studio called BrandCrafters. We build simple, clean websites for local businesses like yours.‚Äù<br><br>
            <strong>Problem</strong><br>
            ‚ÄúI noticed you either don‚Äôt have a website that comes up clearly online or it‚Äôs hard to find info like hours, services, and contact details.‚Äù<br><br>
            <strong>Offer</strong><br>
            ‚ÄúWe do <strong>done-for-you websites</strong> starting at <strong>$249</strong>, and most full business sites are <strong>$699</strong>. That includes your domain and setup ‚Äî you don‚Äôt have to design anything.‚Äù<br><br>
            <strong>Close</strong><br>
            ‚ÄúIf I sent you a quick summary with pricing and examples today, would you be open to looking that over? If you like it, we can lock in your spot and get your site started this week.‚Äù
          </div>
        </article>

        <article class="card" style="margin-bottom:0;">
          <h2>Pricing Snapshot</h2>
          <p class="small">Basic packages (website only). Add-ons are extra.</p>
          <ul class="small" style="padding-left:16px;margin:0 0 8px;">
            <li><strong>Starter Craft ‚Äî $249</strong><br>1-page, simple info site. For very small businesses.</li>
            <li><strong>Business Builder ‚Äî $699</strong><br>3‚Äì5 pages. Our main package for most clients.</li>
            <li><strong>E-Commerce ‚Äî $1,199+</strong><br>Online store or booking. For product/service sales.</li>
          </ul>
          <p class="small">
            <strong>Maintenance (optional, monthly):</strong><br>
            ‚Ä¢ Lite / Standard / Pro (varies per client; admin sets final price).<br>
            ‚Ä¢ Your commission is based on the <strong>website sale</strong>, not small add-ons.
          </p>
          <p class="small">
            <strong>Commission:</strong> $100 per closed website when the invoice is paid.
          </p>
        </article>
      </div>

      <article class="card">
        <h2>Email & DM Templates</h2>
        <p class="small">Copy/paste, then tweak for the business and what you talked about.</p>

        <h3 style="margin:8px 0 4px;font-size:14px;">Follow-up Email</h3>
        <div class="code-block">
          Subject: Quick website idea for {{business_name}}<br><br>
          Hi {{owner_name}},<br><br>
          Thanks for taking a minute to talk earlier. As promised, here‚Äôs a summary of what we can do for {{business_name}}:<br><br>
          ‚Ä¢ A clean, mobile-friendly website so customers can quickly see what you do<br>
          ‚Ä¢ Your hours, services, and contact info in one place<br>
          ‚Ä¢ Domain + basic setup handled for you<br><br>
          Our main package for businesses like yours is <strong>$699</strong> for a full 3‚Äì5 page site. If you‚Äôd like to move forward, just reply ‚ÄúREADY‚Äù and I‚Äôll send the payment link and next steps.<br><br>
          Best,<br>
          {{your_name}}<br>
          BrandCrafters
        </div>

        <h3 style="margin:10px 0 4px;font-size:14px;">Social DM (Facebook / Instagram)</h3>
        <div class="code-block">
          Hey {{name}} üëã I help local businesses build simple, clean websites so people can actually find their info online.<br><br>
          We‚Äôre doing done-for-you sites starting at <strong>$249</strong> (most full sites are <strong>$699</strong>) and that includes the setup so you don‚Äôt have to design anything yourself.<br><br>
          If I send a quick 1-page summary with pricing and examples, would you take a look?
        </div>
      </article>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan   = document.getElementById("userEmail");
  const logoutBtn       = document.getElementById("logoutBtn");

  const myActiveLeadsEl = document.getElementById("myActiveLeads");
  const myClosedWonEl   = document.getElementById("myClosedWon");
  const myCommissionEl  = document.getElementById("myCommission");

  const leadsTableBody  = document.querySelector("#leadsTable tbody");
  const leadsNote       = document.getElementById("leadsNote");
  const statusFilter    = document.getElementById("statusFilter");

  const tabButtons      = document.querySelectorAll(".tab-btn");
  const leadsSection    = document.getElementById("leadsSection");
  const scriptsSection  = document.getElementById("scriptsSection");

  let currentUserEmail  = null;
  let allLeads          = [];

  // Tabs
  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      if (btn.dataset.tab === "leadsSection") {
        leadsSection.classList.add("active");
        scriptsSection.classList.remove("active");
      } else {
        scriptsSection.classList.add("active");
        leadsSection.classList.remove("active");
      }
    });
  });

  function formatMoney(n) {
    if (!n || isNaN(n)) return "$0.00";
    return "$" + Number(n).toFixed(2);
  }

  function statusPill(status) {
    const s = (status || "new").toLowerCase();
    let cls = "pill-blue";
    if (s === "closed won") cls = "pill-green";
    if (s === "working" || s === "no answer") cls = "pill-yellow";
    return `<span class="pill ${cls}">${s}</span>`;
  }

  function renderStats() {
    if (!currentUserEmail) return;
    let active = 0;
    let closed = 0;

    allLeads.forEach(ld => {
      if (ld.assigned_caller_email && ld.assigned_caller_email.toLowerCase() === currentUserEmail) {
        const st = (ld.call_status || "new").toLowerCase();
        if (st === "closed won") closed++;
        else if (st !== "not interested") active++;
      }
    });

    myActiveLeadsEl.textContent = active;
    myClosedWonEl.textContent   = closed;
    myCommissionEl.textContent  = formatMoney(closed * 100);
  }

  function renderLeads() {
    if (!currentUserEmail) return;
    const filter = statusFilter.value;
    leadsTableBody.innerHTML = "";

    const rows = allLeads.filter(ld => {
      const assigned = (ld.assigned_caller_email || "").toLowerCase();
      const st       = (ld.call_status || "new").toLowerCase();

      // Visible if unassigned OR assigned to me
      if (assigned && assigned !== currentUserEmail) return false;

      if (filter === "all") return true;
      return st === filter;
    });

    if (!rows.length) {
      leadsNote.textContent = "No leads match this filter yet.";
    } else {
      leadsNote.textContent = `${rows.length} lead(s) showing.`;
    }

    rows.forEach(ld => {
      const tr = document.createElement("tr");

      const business = ld.business_name || ld.business || "(No name)";
      const city     = ld.city || "";
      const state    = ld.state || "";

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${business}</strong><br><span class="small">${city} ${state}</span>`;
      tr.appendChild(tdBiz);

      const contactParts = [];
      if (ld.phone) contactParts.push(ld.phone);
      if (ld.email) contactParts.push(ld.email);
      if (ld.social) contactParts.push(ld.social);
      const tdContact = document.createElement("td");
      tdContact.innerHTML = contactParts.join("<br>");
      tr.appendChild(tdContact);

      const tdStatus = document.createElement("td");
      tdStatus.innerHTML = statusPill(ld.call_status) +
        (ld.assigned_caller_email ? `<br><span class="small">You</span>` : `<br><span class="small">Unassigned</span>`);
      tr.appendChild(tdStatus);

      const tdLast = document.createElement("td");
      tdLast.innerHTML = `<span class="small">${ld.last_contact_date || "‚Äî"}</span>`;
      tr.appendChild(tdLast);

      const tdActions = document.createElement("td");

      const assignedToMe = ld.assigned_caller_email &&
        ld.assigned_caller_email.toLowerCase() === currentUserEmail;

      if (!ld.assigned_caller_email) {
        const btnClaim = document.createElement("button");
        btnClaim.className = "btn btn-ghost btn-small";
        btnClaim.textContent = "Claim";
        btnClaim.addEventListener("click", () => claimLead(ld.id));
        tdActions.appendChild(btnClaim);
      }

      if (assignedToMe) {
        const select = document.createElement("select");
        ["new","working","no answer","not interested","closed won"].forEach(st => {
          const opt = document.createElement("option");
          opt.value = st;
          opt.textContent = st;
          if ((ld.call_status || "new").toLowerCase() === st) opt.selected = true;
          select.appendChild(opt);
        });
        select.addEventListener("change", () => updateLead(ld.id, { call_status: select.value }));

        const btnNote = document.createElement("button");
        btnNote.className = "btn btn-ghost btn-small";
        btnNote.style.marginLeft = "4px";
        btnNote.textContent = "Add Note";
        btnNote.addEventListener("click", async () => {
          const note = prompt("Add or update notes for this lead:", ld.notes || "");
          if (note !== null) {
            await updateLead(ld.id, { notes: note });
          }
        });

        tdActions.appendChild(select);
        tdActions.appendChild(btnNote);
      }

      tr.appendChild(tdActions);
      leadsTableBody.appendChild(tr);
    });
  }

  async function claimLead(id) {
    if (!currentUserEmail) return;
    const { error } = await supabaseClient
      .from("call_leads")
      .update({ assigned_caller_email: currentUserEmail })
      .eq("id", id);

    if (error) {
      alert("Error claiming lead.");
      console.error(error);
      return;
    }
    await loadLeads();
  }

  async function updateLead(id, fields) {
    const { error } = await supabaseClient
      .from("call_leads")
      .update(fields)
      .eq("id", id);

    if (error) {
      alert("Error updating lead.");
      console.error(error);
      return;
    }
    await loadLeads();
  }

  async function loadLeads() {
    const { data, error } = await supabaseClient
      .from("call_leads")
      .select("*")
      .order("id", { ascending: true });

    if (error) {
      console.error(error);
      leadsNote.textContent = "Error loading leads.";
      return;
    }
    allLeads = data || [];
    renderStats();
    renderLeads();
  }

  statusFilter.addEventListener("change", renderLeads);

  logoutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    window.location.href = "dashboard.html";
  });

  (async () => {
    const { data } = await supabaseClient.auth.getUser();
    if (!data || !data.user) {
      // no session ‚Üí send them to main login
      window.location.href = "dashboard.html";
      return;
    }
    currentUserEmail = (data.user.email || "").toLowerCase();
    userEmailSpan.textContent = currentUserEmail;

    await loadLeads();
  })();
</script>
</body>
                                                       </html>
