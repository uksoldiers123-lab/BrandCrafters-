<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Contractor Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- BrandCrafters base styles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="script.js"></script>

  <style>
    body{
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#f5f5ff;
    }
    main{
      max-width:1100px;
      margin:32px auto 80px;
      padding:0 20px;
    }
    h1{
      margin:0 0 6px;
      font-size:24px;
    }
    .subhead{
      margin:0 0 20px;
      font-size:13px;
      color:var(--muted);
    }

    .grid-3{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    @media(max-width:900px){
      .grid-3{grid-template-columns:1fr;}
    }

    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.1);
      padding:12px 14px;
      font-size:13px;
    }
    .card-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:var(--muted);
    }
    .card-value{
      font-size:18px;
      font-weight:700;
      margin-top:4px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
      font-size:12px;
    }
    .toolbar select{
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.04);
      color:#f5f5ff;
      font-size:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:4px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
      background:rgba(255,255,255,.02);
      position:sticky;
      top:0;
      z-index:1;
    }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.05em;
    }
    .badge-priority-a{background:rgba(255,210,130,.18);color:#ffd282;}
    .badge-priority-b{background:rgba(130,190,255,.18);color:#a5c7ff;}
    .badge-priority-c{background:rgba(180,255,190,.14);color:#b9ffbf;}

    .badge-status-new{background:rgba(130,190,255,.18);color:#a5c7ff;}
    .badge-status-inprogress{background:rgba(255,210,130,.18);color:#ffd282;}
    .badge-status-closedwon{background:rgba(180,255,190,.18);color:#b9ffbf;}
    .badge-status-closedlost{background:rgba(255,150,150,.18);color:#ffb1b1;}

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.04);
      color:#f5f5ff;
      font-size:11px;
      cursor:pointer;
      transition:.18s;
      text-decoration:none;
    }
    .btn:hover{
      background:rgba(255,255,255,.1);
      transform:translateY(-1px);
    }
    .btn-primary{
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .btn-small{
      padding:4px 8px;
      font-size:10px;
    }

    .notes-input{
      width:100%;
      min-width:160px;
      max-width:300px;
      min-height:40px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      color:#f5f5ff;
      font-size:11px;
      padding:4px 6px;
      resize:vertical;
      font-family:inherit;
    }
    .select-inline,
    .date-inline{
      width:100%;
      max-width:120px;
      padding:4px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      color:#f5f5ff;
      font-size:11px;
    }

    .status-msg{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }

    /* Header extra bits for email + logout */
    .header-user{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
      margin-left:12px;
    }
    .btn-logout{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(255,255,255,.08);
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-logout:hover{
      background:rgba(255,255,255,.16);
      transform:translateY(-1px);
    }
    @media(max-width:940px){
      .header-user{display:none;}
    }

    .muted-link{
      font-size:11px;
      color:var(--muted);
      text-decoration:underline;
      text-decoration-style:dotted;
    }
  </style>
</head>
<body>

<!-- BrandCrafters header with dashboard links (Version B) -->
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <!-- Desktop Nav -->
    <nav class="nav desktop-nav">
      <!-- Public nav -->
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="btn btn-outline">Customer Portal</a>

      <!-- Dashboard-specific links -->
      <a href="dashboard.html" class="nav-link">Admin Dashboard</a>
      <a href="dashboard-leads-upload.html" class="nav-link">Leads &amp; CSV</a>
      <a href="contractor-portal.html" class="nav-link active">Contractor Portal</a>

      <!-- User + logout -->
      <div class="header-user">
        <span id="userEmail"></span>
        <button id="logoutBtn" class="btn-logout">Log Out</button>
      </div>
    </nav>

    <!-- Mobile: Hamburger -->
    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <!-- Mobile Drawer -->
  <nav class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close" aria-label="Close menu">✕</button>
    </div>

    <!-- Public nav -->
    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>

    <!-- Dashboard-specific -->
    <a class="drawer-link" href="dashboard.html">Admin Dashboard</a>
    <a class="drawer-link" href="dashboard-leads-upload.html">Leads &amp; CSV</a>
    <a class="drawer-link" href="contractor-portal.html">Contractor Portal</a>
  </nav>
  <div class="drawer-backdrop" aria-hidden="true"></div>
</header>

<main>
  <section>
    <h1>Contractor Portal</h1>
    <p class="subhead">
      Claim leads, update call statuses, and track your commissions.  
      For scripts, pricing, and pre-made messages, see
      <a href="contractor-webbook.html" class="muted-link" target="_blank">Scripts &amp; WebBook</a>.
    </p>
  </section>

  <section class="grid-3">
    <article class="card">
      <div class="card-label">Your Email</div>
      <div class="card-value" id="summaryEmail">—</div>
    </article>
    <article class="card">
      <div class="card-label">Open Leads (Assigned to You)</div>
      <div class="card-value" id="summaryOpenLeads">0</div>
    </article>
    <article class="card">
      <div class="card-label">Closed Won · Est. Commission</div>
      <div class="card-value" id="summaryCommission">$0.00</div>
      <div class="status-msg" id="summaryClosedWon">0 closed won · $100 per website sale</div>
    </article>
  </section>

  <section class="card">
    <div class="toolbar">
      <span style="font-size:11px;color:var(--muted);">Filter:</span>
      <select id="filterScope">
        <option value="mine">My leads (assigned to me)</option>
        <option value="unassigned">Unassigned leads only</option>
        <option value="mine_unassigned">My + Unassigned (default)</option>
        <option value="all">All leads I can see</option>
      </select>
      <select id="filterStatus">
        <option value="open">Open (new + in progress)</option>
        <option value="new">New only</option>
        <option value="in_progress">In progress only</option>
        <option value="closed">Closed (won + lost)</option>
        <option value="any">Any status</option>
      </select>
      <span style="flex:1 1 auto;"></span>
      <span class="muted">Tip: Claim a lead first, then update status &amp; notes.</span>
    </div>

    <div style="overflow:auto;max-height:520px;">
      <table id="leadsTable">
        <thead>
          <tr>
            <th>Lead</th>
            <th>Contact</th>
            <th>Location</th>
            <th>Web / Social</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Notes / Last Contact</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="status-msg" id="tableStatusMsg"></div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>
      © <span id="year"></span> BrandCrafters — A division of Egyptian Hype LLC
      <a href="dashboard.html" class="admin-link">Admin</a>
    </div>
  </div>
</footer>

<!-- Year -->
<script>
  const yearSpan = document.getElementById('year');
  if (yearSpan) {
    yearSpan.textContent = new Date().getFullYear();
  }
</script>

<!-- Supabase + Contractor Logic -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIsInZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const ADMIN_EMAIL = "srarnold216@gmail.com";
  const LOGIN_PAGE_URL = "dashboard.html";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan      = document.getElementById("userEmail");
  const logoutBtn          = document.getElementById("logoutBtn");
  const summaryEmail       = document.getElementById("summaryEmail");
  const summaryOpenLeads   = document.getElementById("summaryOpenLeads");
  const summaryCommission  = document.getElementById("summaryCommission");
  const summaryClosedWon   = document.getElementById("summaryClosedWon");
  const filterScopeSelect  = document.getElementById("filterScope");
  const filterStatusSelect = document.getElementById("filterStatus");
  const leadsTableBody     = document.querySelector("#leadsTable tbody");
  const tableStatusMsg     = document.getElementById("tableStatusMsg");

  let currentUserEmail = null;
  let allLeads = [];

  async function guardContractor(){
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) {
      console.error("auth.getUser error:", error);
    }
    if (!data || !data.user) {
      // not logged in -> send to login gate (dashboard.html)
      window.location.href = LOGIN_PAGE_URL;
      return null;
    }
    const email = data.user.email;
    currentUserEmail = email;
    if (userEmailSpan) userEmailSpan.textContent = email || "";
    if (summaryEmail) summaryEmail.textContent = email || "—";

    // If this is admin, send to admin dashboard, not contractor portal
    if (email === ADMIN_EMAIL) {
      window.location.href = "dashboard.html";
      return null;
    }
    return data.user;
  }

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      window.location.href = LOGIN_PAGE_URL;
    });
  }

  function formatMoney(n){
    if (!n || isNaN(n)) return "$0.00";
    return "$" + Number(n).toFixed(2);
  }

  function badgeForPriority(p){
    const pri = (p || "").toUpperCase();
    if (pri === "A") return `<span class="badge badge-priority-a">A · Hot (No Site)</span>`;
    if (pri === "B") return `<span class="badge badge-priority-b">B · Needs Upgrade</span>`;
    if (pri === "C") return `<span class="badge badge-priority-c">C · Warm</span>`;
    return `<span class="badge">?</span>`;
  }

  function badgeForStatus(s){
    const st = (s || "new").toLowerCase();
    if (st === "new") return `<span class="badge badge-status-new">New</span>`;
    if (st === "in progress" || st === "in_progress") return `<span class="badge badge-status-inprogress">In Progress</span>`;
    if (st === "closed won" || st === "closed_won") return `<span class="badge badge-status-closedwon">Closed Won</span>`;
    if (st === "closed lost" || st === "closed_lost") return `<span class="badge badge-status-closedlost">Closed Lost</span>`;
    return `<span class="badge">${st}</span>`;
  }

  function filterLeads(){
    const scope = filterScopeSelect.value;
    const statusFilter = filterStatusSelect.value;

    let rows = allLeads.slice();

    rows = rows.filter(ld => {
      const assigned = ld.assigned_caller_email;
      const st = (ld.call_status || "new").toLowerCase();

      // scope
      if (scope === "mine" && assigned !== currentUserEmail) return false;
      if (scope === "unassigned" && assigned) return false;
      if (scope === "mine_unassigned" && !(assigned === currentUserEmail || !assigned)) return false;
      // scope "all" -> no restriction

      // status
      if (statusFilter === "open") {
        if (!(st === "new" || st === "in progress" || st === "in_progress")) return false;
      } else if (statusFilter === "new") {
        if (st !== "new") return false;
      } else if (statusFilter === "in_progress") {
        if (!(st === "in progress" || st === "in_progress")) return false;
      } else if (statusFilter === "closed") {
        if (!(st === "closed won" || st === "closed_won" || st === "closed lost" || st === "closed_lost")) return false;
      }
      return true;
    });

    // sort by priority A -> B -> C, then by created_at desc
    const priOrder = { "A":0, "B":1, "C":2 };
    rows.sort((a,b) => {
      const pa = priOrder[(a.priority || "").toUpperCase()] ?? 9;
      const pb = priOrder[(b.priority || "").toUpperCase()] ?? 9;
      if (pa !== pb) return pa - pb;
      const da = new Date(a.created_at || 0);
      const db = new Date(b.created_at || 0);
      return db - da;
    });

    renderLeads(rows);
  }

  function renderLeads(rows){
    leadsTableBody.innerHTML = "";
    if (!rows.length){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 8;
      td.className = "status-msg";
      td.textContent = "No leads match this filter.";
      tr.appendChild(td);
      leadsTableBody.appendChild(tr);
      tableStatusMsg.textContent = "";
      return;
    }

    rows.forEach(ld => {
      const tr = document.createElement("tr");

      const st = (ld.call_status || "new").toLowerCase();
      const isClosedWon = (st === "closed won" || st === "closed_won");
      const assigned = ld.assigned_caller_email;
      const isMine = assigned === currentUserEmail;

      const tdLead = document.createElement("td");
      tdLead.innerHTML = `<strong>${ld.business_name || "(no name)"}</strong><br><span class="status-msg">${ld.notes || ""}</span>`;
      tr.appendChild(tdLead);

      const tdContact = document.createElement("td");
      tdContact.innerHTML = `
        <div>${ld.phone || ""}</div>
        <div class="status-msg">${ld.email || ""}</div>
      `;
      tr.appendChild(tdContact);

      const tdLoc = document.createElement("td");
      tdLoc.textContent = [ld.city, ld.state].filter(Boolean).join(", ");
      tr.appendChild(tdLoc);

      const tdWeb = document.createElement("td");
      const web = ld.website || "";
      const soc = ld.social || "";
      if (web) {
        tdWeb.innerHTML = `<div><a href="${web}" target="_blank">${web}</a></div>`;
      }
      if (soc) {
        tdWeb.innerHTML += `<div class="status-msg"><a href="${soc}" target="_blank">${soc}</a></div>`;
      }
      if (!web && !soc) {
        tdWeb.textContent = "—";
      }
      tr.appendChild(tdWeb);

      const tdPri = document.createElement("td");
      tdPri.innerHTML = badgeForPriority(ld.priority);
      tr.appendChild(tdPri);

      const tdStatus = document.createElement("td");
      tdStatus.innerHTML = `
        ${badgeForStatus(ld.call_status)}
        <div class="status-msg">
          Assigned: ${assigned ? assigned : "Unassigned"}
        </div>
      `;
      tr.appendChild(tdStatus);

      const tdNotes = document.createElement("td");
      const notesId = `notes-${ld.id}`;
      const dateId  = `date-${ld.id}`;
      tdNotes.innerHTML = `
        <textarea id="${notesId}" class="notes-input" placeholder="Call notes, promises, follow-up plan…">${ld.notes || ""}</textarea>
        <div style="margin-top:4px;">
          <label style="font-size:10px;color:var(--muted);display:block;">
            Last Contact
            <input type="date" id="${dateId}" class="date-inline" value="${ld.last_contact_date || ""}">
          </label>
        </div>
      `;
      tr.appendChild(tdNotes);

      const tdActions = document.createElement("td");
      const selectId = `status-${ld.id}`;
      const canEdit = !assigned || isMine; // only unassigned or your own
      tdActions.innerHTML = `
        <select id="${selectId}" class="select-inline" ${canEdit ? "" : "disabled"}>
          <option value="new" ${st === "new" ? "selected" : ""}>New</option>
          <option value="in progress" ${st === "in progress" || st === "in_progress" ? "selected" : ""}>In Progress</option>
          <option value="closed won" ${isClosedWon ? "selected" : ""}>Closed Won</option>
          <option value="closed lost" ${st === "closed lost" || st === "closed_lost" ? "selected" : ""}>Closed Lost</option>
        </select>
        <div style="margin-top:4px;display:flex;flex-direction:column;gap:4px;">
          ${assigned ? "" : `<button class="btn btn-small btn-primary" data-action="claim" data-id="${ld.id}">Claim Lead</button>`}
          ${canEdit ? `<button class="btn btn-small" data-action="save" data-id="${ld.id}">Save</button>` : `<span class="status-msg">Read-only (assigned to ${assigned})</span>`}
        </div>
      `;
      tr.appendChild(tdActions);

      leadsTableBody.appendChild(tr);
    });

    tableStatusMsg.textContent = `${rows.length} lead(s) shown.`;
  }

  async function loadLeads(){
    tableStatusMsg.textContent = "Loading leads…";

    const { data, error } = await supabaseClient
      .from("call_leads")
      .select("*");

    if (error){
      console.error("call_leads error:", error);
      tableStatusMsg.textContent = "Error loading leads: " + error.message;
      return;
    }

    allLeads = data || [];

    const myOpen = allLeads.filter(ld => {
      const st = (ld.call_status || "new").toLowerCase();
      return ld.assigned_caller_email === currentUserEmail &&
        (st === "new" || st === "in progress" || st === "in_progress");
    }).length;

    let myClosedWon = 0;
    allLeads.forEach(ld => {
      const st = (ld.call_status || "new").toLowerCase();
      if (ld.assigned_caller_email === currentUserEmail &&
          (st === "closed won" || st === "closed_won")) {
        myClosedWon += 1;
      }
    });
    const myCommission = myClosedWon * 100;

    summaryOpenLeads.textContent = myOpen;
    summaryCommission.textContent = formatMoney(myCommission);
    summaryClosedWon.textContent = `${myClosedWon} closed won · $100 per website sale`;

    filterScopeSelect.value = "mine_unassigned";
    filterStatusSelect.value = "open";
    filterLeads();
  }

  async function claimLead(id){
    if (!currentUserEmail) return;
    const { error } = await supabaseClient
      .from("call_leads")
      .update({ assigned_caller_email: currentUserEmail, call_status: "in progress" })
      .eq("id", id);

    if (error){
      console.error("claim lead error:", error);
      alert("Error claiming lead: " + error.message);
      return;
    }
    await loadLeads();
  }

  async function saveLead(id){
    const notesEl = document.getElementById(`notes-${id}`);
    const dateEl  = document.getElementById(`date-${id}`);
    const statusEl = document.getElementById(`status-${id}`);
    if (!notesEl || !dateEl || !statusEl) return;

    const notes = notesEl.value || "";
    const lastContact = dateEl.value || null;
    const statusVal = statusEl.value || "new";

    const { error } = await supabaseClient
      .from("call_leads")
      .update({
        notes,
        last_contact_date: lastContact,
        call_status: statusVal
      })
      .eq("id", id);

    if (error){
      console.error("save lead error:", error);
      alert("Error saving lead: " + error.message);
      return;
    }
    await loadLeads();
  }

  leadsTableBody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button[data-action]");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    const action = btn.getAttribute("data-action");
    if (!id || !action) return;

    if (action === "claim") {
      await claimLead(id);
    } else if (action === "save") {
      await saveLead(id);
    }
  });

  filterScopeSelect.addEventListener("change", filterLeads);
  filterStatusSelect.addEventListener("change", filterLeads);

  (async () => {
    const user = await guardContractor();
    if (!user) return;
    await loadLeads();
  })();
</script>
</body>
</html>
