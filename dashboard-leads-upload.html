<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Leads & CSV Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- BrandCrafters base styles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
  <script defer src="script.js"></script>

  <style>
    body{
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:#f5f5ff;
    }
    main{
      max-width:1100px;
      margin:32px auto 80px;
      padding:0 20px;
    }
    h1{
      margin:0 0 6px;
      font-size:24px;
    }
    .subhead{
      margin:0 0 20px;
      font-size:13px;
      color:var(--muted);
    }

    .panel{
      background:var(--panel);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      padding:16px 14px;
      margin-bottom:16px;
    }
    .panel h2{
      margin:0 0 6px;
      font-size:16px;
    }
    .panel p{
      margin:0 0 8px;
      font-size:13px;
      color:var(--muted);
    }

    .grid-2{
      display:grid;
      grid-template-columns:2fr 3fr;
      gap:14px;
    }
    @media(max-width:900px){
      .grid-2{
        grid-template-columns:1fr;
      }
    }

    input[type="file"]{
      display:block;
      margin-top:8px;
      font-size:13px;
      color:var(--text);
    }

    .btn{
      display:inline-block;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.2);
      font-size:13px;
      cursor:pointer;
      background:rgba(255,255,255,.04);
      color:var(--text);
      transition:.18s;
    }
    .btn:hover{
      background:rgba(255,255,255,.1);
      transform:translateY(-1px);
    }
    .btn-primary{
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .btn-primary:hover{
      filter:brightness(1.05);
    }

    .msg{
      font-size:13px;
      margin-top:6px;
    }
    .msg.error{color:#ff9c9c;}
    .msg.ok{color:#8bffb0;}
    .muted{
      color:var(--muted);
      font-size:11px;
    }
    .mono{
      font-family:monospace;
      font-size:11px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:4px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
      background:rgba(255,255,255,.02);
    }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .badge-valid{
      background:rgba(142,255,191,.12);
      color:#8effbf;
    }
    .badge-invalid{
      background:rgba(255,177,177,.15);
      color:#ffb1b1;
    }

    /* Header extra bits for email + logout */
    .header-user{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
      margin-left:12px;
    }
    .btn-logout{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.55);
      background:rgba(255,255,255,.08);
      font-size:11px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-logout:hover{
      background:rgba(255,255,255,.16);
      transform:translateY(-1px);
    }
    @media(max-width:940px){
      .header-user{display:none;}
    }
  </style>
</head>
<body>

<!-- BrandCrafters header with dashboard links (Version B) -->
<header class="site-header">
  <div class="container header-inner">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>

    <!-- Desktop Nav -->
    <nav class="nav desktop-nav">
      <!-- Public nav -->
      <a href="index.html" class="nav-link">Home</a>
      <a href="pricing.html" class="nav-link">Pricing</a>
      <a href="customer-inquiry.html" class="btn btn-outline">Customer Portal</a>

      <!-- Dashboard-specific links -->
      <a href="dashboard.html" class="nav-link">Admin Dashboard</a>
      <a href="dashboard-leads-upload.html" class="nav-link active">Leads &amp; CSV</a>
      <a href="contractor-portal.html" class="nav-link">Contractor Portal</a>

      <!-- User + logout -->
      <div class="header-user">
        <span id="userEmail"></span>
        <button id="logoutBtn" class="btn-logout">Log Out</button>
      </div>
    </nav>

    <!-- Mobile: Hamburger -->
    <button class="menu-toggle" aria-label="Open menu" aria-expanded="false">
      <span></span><span></span><span></span>
    </button>
  </div>

  <!-- Mobile Drawer (V8) -->
  <nav class="mobile-drawer" aria-hidden="true">
    <div class="drawer-header">
      <a class="logo" href="index.html">
        <span class="logo-mark">BC</span><span>BrandCrafters</span>
      </a>
      <button class="menu-close" aria-label="Close menu">✕</button>
    </div>

    <!-- Public nav -->
    <a class="drawer-link" href="index.html">Home</a>
    <a class="drawer-link" href="pricing.html">Pricing</a>
    <a class="drawer-link" href="customer-inquiry.html">Customer Portal</a>

    <!-- Dashboard-specific -->
    <a class="drawer-link" href="dashboard.html">Admin Dashboard</a>
    <a class="drawer-link" href="dashboard-leads-upload.html">Leads &amp; CSV</a>
    <a class="drawer-link" href="contractor-portal.html">Contractor Portal</a>
  </nav>
  <div class="drawer-backdrop" aria-hidden="true"></div>
</header>

<main>
  <section>
    <h1>Upload Leads CSV</h1>
    <p class="subhead">
      Drop in new lead lists from Google Maps, directories, or spreadsheets. We’ll auto-map columns,
      validate rows, and set lead priority (A/B/C) based on web presence.
    </p>
  </section>

  <section class="panel grid-2">
    <div>
      <h2>1. Choose CSV</h2>
      <p>
        Core fields we care about:
        <span class="mono">business_name, phone, city, state</span>.<br>
        We also accept headers like <span class="mono">BusinessName, Company, Phone, Email</span> and auto-map them.
      </p>
      <input type="file" id="csvFile" accept=".csv" />
      <div style="margin-top:10px;">
        <button class="btn" id="previewBtn">Preview</button>
        <button class="btn btn-primary" id="uploadBtn" disabled>Upload to Supabase</button>
      </div>
      <div id="uploadMsg" class="msg"></div>
      <p class="muted" style="margin-top:8px;">
        Auto-rules:
        <br>• If <b>website</b> is empty ➜ priority <b>A</b>
        <br>• If only social / Facebook / Google link ➜ priority <b>B</b>
        <br>• If real website present ➜ priority <b>C</b>
        <br>• <b>call_status</b> defaults to <span class="mono">new</span> if missing
      </p>
    </div>
    <div>
      <h2>2. Status</h2>
      <p class="muted">
        We’ll show valid vs invalid rows before upload. Invalid (missing business name or phone) will be skipped.
      </p>
      <div id="previewStats" class="msg"></div>
      <div id="headerMapInfo" class="muted"></div>
    </div>
  </section>

  <section class="panel">
    <h2>Preview (first 25 rows)</h2>
    <div class="muted">Red badge = missing phone or business name (row will be skipped).</div>
    <div style="overflow:auto;max-height:400px;margin-top:8px;">
      <table id="previewTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <div>
      © <span id="year"></span> BrandCrafters — A division of Egyptian Hype LLC
      <a href="dashboard.html" class="admin-link">Admin</a>
    </div>
  </div>
</footer>

<!-- Year -->
<script>
  const yearSpan = document.getElementById('year');
  if (yearSpan) {
    yearSpan.textContent = new Date().getFullYear();
  }
</script>

<!-- Supabase + CSV logic -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIsInZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const ADMIN_EMAIL = "srarnold216@gmail.com";
  const LOGIN_PAGE_URL = "dashboard.html";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan   = document.getElementById("userEmail");
  const logoutBtn       = document.getElementById("logoutBtn");

  async function guardAdmin() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) {
      console.error("auth.getUser error:", error);
    }
    if (!data || !data.user) {
      return null;
    }
    const email = data.user.email;
    if (userEmailSpan) userEmailSpan.textContent = email || "";

    if (email !== ADMIN_EMAIL) {
      window.location.href = "contractor-portal.html";
      return null;
    }
    return data.user;
  }

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      await supabaseClient.auth.signOut();
      window.location.href = LOGIN_PAGE_URL;
    });
  }

  const fileInput   = document.getElementById("csvFile");
  const previewBtn  = document.getElementById("previewBtn");
  const uploadBtn   = document.getElementById("uploadBtn");
  const previewStats = document.getElementById("previewStats");
  const headerMapInfo = document.getElementById("headerMapInfo");
  const uploadMsg   = document.getElementById("uploadMsg");

  const previewTableHead = document.querySelector("#previewTable thead");
  const previewTableBody = document.querySelector("#previewTable tbody");

  let parsedRows = [];
  let mappedRows = [];
  let lastHeaderMap = {};

  const headerAliases = {
    business_name: ["business_name","businessname","name","company","companyname"],
    phone: ["phone","phone1","phonenumber","primaryphone"],
    alt_phone: ["altphone","phone2","secondaryphone","alt_phone"],
    email: ["email","emailaddress","primaryemail"],
    alt_email: ["altemail","email2","secondaryemail","alt_email"],
    city: ["city","town"],
    state: ["state","st"],
    website: ["website","site","url","websiteurl"],
    social: ["social","facebook","fbpage","instagram","ig","sociallink"],
    priority: ["priority","tier"],
    call_status: ["call_status","status","leadstatus"],
    assigned_caller_email: ["assigned_caller_email","caller","agent_email","assignedto"],
    notes: ["notes","note","comments","comment","details"]
  };

  function normalizeHeader(h){
    return h.toString().trim().toLowerCase().replace(/[\s_-]+/g,"");
  }

  function findCanonicalColumn(header){
    const norm = normalizeHeader(header);
    for (const [canonical, aliasList] of Object.entries(headerAliases)) {
      if (aliasList.includes(norm)) return canonical;
    }
    if (headerAliases[header]) return header;
    return null;
  }

  function autoPriority(website){
    if (!website || website.trim() === "") return "A";
    const w = website.toLowerCase();
    if (
      w.includes("facebook.com") ||
      w.includes("instagram.com") ||
      w.includes("google.com") ||
      w.includes("glossgenius") ||
      w.includes("square.site") ||
      w.includes("linktr.ee")
    ) {
      return "B";
    }
    return "C";
  }

  function buildPreview(){
    previewTableHead.innerHTML = "";
    previewTableBody.innerHTML = "";
    previewStats.textContent = "";
    headerMapInfo.textContent = "";
    uploadMsg.textContent = "";
    uploadMsg.className = "msg";

    if (!parsedRows.length){
      previewStats.textContent = "No rows parsed yet. Choose a CSV and click Preview.";
      return;
    }

    mappedRows = [];
    lastHeaderMap = {};

    const csvHeaders = Object.keys(parsedRows[0] || {});
    const canonicalForHeader = {};

    csvHeaders.forEach(h => {
      const canonical = findCanonicalColumn(h);
      canonicalForHeader[h] = canonical;
      if (canonical) {
        lastHeaderMap[h] = canonical;
      } else {
        lastHeaderMap[h] = "(ignored)";
      }
    });

    let validCount = 0;
    let invalidCount = 0;

    parsedRows.forEach(row => {
      const obj = {
        business_name: "",
        phone: "",
        alt_phone: "",
        email: "",
        alt_email: "",
        city: "",
        state: "",
        website: "",
        social: "",
        priority: "",
        call_status: "",
        assigned_caller_email: "",
        notes: ""
      };

      for (const [rawHeader, value] of Object.entries(row)) {
        const canonical = canonicalForHeader[rawHeader];
        if (!canonical || !(canonical in obj)) continue;
        obj[canonical] = (value ?? "").toString().trim();
      }

      if (!obj.call_status) obj.call_status = "new";
      if (!obj.priority) obj.priority = autoPriority(obj.website);

      if (!obj.website && obj.social) {
        const pr = autoPriority(obj.social);
        if (!obj.priority) obj.priority = pr;
      }

      const missingCore = !obj.business_name || !obj.phone;
      if (missingCore) invalidCount++; else validCount++;

      obj._invalid = missingCore;
      mappedRows.push(obj);
    });

    previewStats.textContent =
      `Parsed ${parsedRows.length} rows · ` +
      `${validCount} valid · ${invalidCount} invalid (missing business name or phone — skipped on upload).`;
    previewStats.className = "msg " + (invalidCount ? "error" : "ok");

    const items = Object.entries(lastHeaderMap).map(([csvH, canon]) =>
      `${csvH} → ${canon}`
    );
    headerMapInfo.textContent = "Header mapping: " + items.join(" · ");

    const displayRows = mappedRows.slice(0, 25);
    const headTr = document.createElement("tr");
    ["Status","Business","Phone","City/State","Website/Social","Priority","Call Status","Notes"].forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      headTr.appendChild(th);
    });
    previewTableHead.appendChild(headTr);

    displayRows.forEach(r => {
      const tr = document.createElement("tr");

      const tdStatus = document.createElement("td");
      const badge = document.createElement("span");
      badge.classList.add("badge");
      if (r._invalid) {
        badge.classList.add("badge-invalid");
        badge.textContent = "Invalid";
      } else {
        badge.classList.add("badge-valid");
        badge.textContent = "OK";
      }
      tdStatus.appendChild(badge);
      tr.appendChild(tdStatus);

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${r.business_name || "(missing)"}</strong><br><span class="muted">${r.email || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = r.phone || "(missing)";
      tr.appendChild(tdPhone);

      const tdCity = document.createElement("td");
      tdCity.textContent = [r.city, r.state].filter(Boolean).join(", ");
      tr.appendChild(tdCity);

      const tdWeb = document.createElement("td");
      tdWeb.textContent = r.website || (r.social || "");
      tr.appendChild(tdWeb);

      const tdPri = document.createElement("td");
      tdPri.textContent = r.priority || "";
      tr.appendChild(tdPri);

      const tdStat = document.createElement("td");
      tdStat.textContent = r.call_status || "";
      tr.appendChild(tdStat);

      const tdNotes = document.createElement("td");
      tdNotes.textContent = r.notes || "";
      tr.appendChild(tdNotes);

      previewTableBody.appendChild(tr);
    });

    uploadBtn.disabled = !mappedRows.length;
  }

  previewBtn.addEventListener("click", () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file){
      previewStats.textContent = "Please choose a CSV file first.";
      previewStats.className = "msg error";
      return;
    }

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: results => {
        parsedRows = results.data || [];
        buildPreview();
      },
      error: err => {
        previewStats.textContent = "Error parsing CSV: " + err.message;
        previewStats.className = "msg error";
      }
    });
  });

  uploadBtn.addEventListener("click", async () => {
    uploadMsg.textContent = "";
    uploadMsg.className = "msg";

    if (!mappedRows.length){
      uploadMsg.textContent = "Nothing to upload. Click Preview first.";
      uploadMsg.className = "msg error";
      return;
    }

    const valid = mappedRows.filter(r => !r._invalid);
    if (!valid.length){
      uploadMsg.textContent = "All rows are invalid (missing business name or phone). Nothing uploaded.";
      uploadMsg.className = "msg error";
      return;
    }

    uploadBtn.disabled = true;
    uploadMsg.textContent = "Uploading " + valid.length + " valid rows to Supabase…";

    const cleanRows = valid.map(({_invalid, ...rest}) => rest);

    const { data, error } = await supabaseClient
      .from("call_leads")
      .insert(cleanRows);

    if (error){
      console.error(error);
      uploadMsg.textContent = "Error inserting rows: " + error.message;
      uploadMsg.className = "msg error";
    } else {
      uploadMsg.textContent = `Uploaded ${cleanRows.length} rows successfully. Invalid rows were skipped.`;
      uploadMsg.className = "msg ok";
    }
    uploadBtn.disabled = false;
  });

  (async () => {
    await guardAdmin();
  })();
</script>
</body>
</html>
