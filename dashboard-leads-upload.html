<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Leads &amp; CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#050713;
      --panel:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.08);
      --text:#f5f5ff;
      --muted:#b5b7d8;
      --grad:linear-gradient(135deg,#6ea8ff,#b166ff);
      --danger:rgba(255,120,120,0.14);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #18122f 0, rgba(24,18,47,0) 60%),
        var(--bg);
      color:var(--text);
    }
    a{text-decoration:none;color:var(--text);}
    header{
      position:sticky;top:0;z-index:40;
      background:rgba(5,7,19,.95);
      backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .header-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .logo{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:14px;
    }
    .logo-mark{
      display:inline-grid;
      place-items:center;
      width:32px;
      height:32px;
      border-radius:12px;
      background:var(--grad);
      color:#050713;
      font-weight:800;
      font-size:14px;
    }
    .brand-sub{
      font-size:12px;
      color:var(--muted);
    }
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .nav a{
      font-size:13px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.04);
      text-decoration:none;
      color:var(--text);
      transition:.18s;
    }
    .nav a.primary{
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .nav a:hover{
      background:rgba(255,255,255,.10);
      transform:translateY(-1px);
    }
    .nav a.primary:hover{
      filter:brightness(1.05);
    }
    .user-email{font-size:12px;color:var(--muted);}
    .logout-btn{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,.5);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(110,168,255,.3);
      transition:.18s;
    }
    .logout-btn:hover{
      background:rgba(255,255,255,.16);
      transform:translateY(-1px);
    }

    main{
      max-width:1100px;margin:18px auto 60px;
      padding:0 16px;
    }
    h1{margin:0 0 6px;font-size:22px;}
    .subhead{margin:0 0 18px;font-size:13px;color:var(--muted);}
    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:16px 14px;
      margin-bottom:16px;
    }
    .card h2{margin:0 0 8px;font-size:16px;}
    .card p{margin:0 0 6px;font-size:13px;}
    .small{font-size:12px;color:var(--muted);}
    input[type="file"]{
      margin-top:8px;
      padding:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(8,10,24,.9);
      color:var(--text);
      font-size:13px;
      max-width:100%;
    }
    .btn{
      display:inline-block;
      margin-top:10px;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      background:var(--grad);
      color:#050713;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .btn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    .btn-small{
      padding:4px 10px;
      font-size:11px;
      margin-top:0;
    }
    .btn-danger{
      background:var(--danger);
      color:#ffb3b3;
      border:1px solid rgba(255,120,120,0.6);
      box-shadow:none;
      margin-left:6px;
    }
    .btn-danger:hover{
      background:rgba(255,120,120,0.22);
      transform:translateY(-1px);
    }
    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px;}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:5px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
    }
    .priority-badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(110,168,255,.15);
    }
    .priority-badge.a{background:rgba(111,255,193,.15);}
    .priority-badge.b{background:rgba(255,230,150,.2);}
    .priority-badge.c{background:rgba(255,164,164,.2);}
    .error{color:#ffb3b3;font-size:12px;margin-top:6px;}
    .hidden{display:none;}
    .center-msg{
      text-align:center;
      margin-top:40px;
      color:var(--muted);
      font-size:13px;
    }
    .row-actions .btn{
      margin-right:4px;
    }
    .edit-form label{
      display:block;
      font-size:12px;
      margin-bottom:8px;
    }
    .edit-form select,
    .edit-form input[type="checkbox"]{
      margin-top:4px;
    }
    .toggle-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:4px;
    }
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <a class="logo" href="index.html">
      <span class="logo-mark">BC</span><span>BrandCrafters</span>
    </a>
    <span class="brand-sub">Admin · Leads &amp; CSV</span>
  </div>
  <div class="nav">
    <a href="dashboard.html">Dashboard</a>
    <a href="dashboard-leads-upload.html" class="primary">Leads &amp; CSV</a>
    <a href="contractor-portal.html" target="_blank">Contractor Portal</a>
    <span class="user-email" id="userEmail"></span>
    <button id="logoutBtn" class="logout-btn" type="button">Log Out</button>
  </div>
</header>

<main>
  <section id="accessMessage" class="center-msg"></section>

  <section id="leadsContent" class="hidden">
    <h1>Leads &amp; CSV Upload</h1>
    <p class="subhead">
      Upload lead lists, clean them up, and set which BrandCrafters package + upsells each lead should be pitched.
    </p>

    <!-- UPLOAD + DELETE ALL -->
    <article class="card">
      <h2>Upload / Add Leads from CSV</h2>
      <p class="small">
        CSV headers should look like:<br>
        <b>
          BusinessName, Phone, Email, AltEmail, Website, Social, City, State, Priority,
          CallStatus, Notes, TargetPackage, UpsellMaintenance, UpsellDashboard,
          UpsellPaymentLinks, UpsellSEO, UpsellSocialKit
        </b><br>
        (Upsell columns are optional; “true/false” or “yes/no” will be read.)
      </p>
      <input type="file" id="csvFile" accept=".csv" />
      <div>
        <button class="btn" id="uploadBtn" type="button">Upload Leads</button>
        <button class="btn btn-danger" id="deleteAllBtn" type="button">Delete ALL Leads</button>
      </div>
      <div id="uploadStatus" class="small"></div>
      <div id="uploadError" class="error"></div>
    </article>

    <!-- BULK TARGETING -->
    <article class="card">
      <h2>Bulk Targeting (Apply to Visible Leads)</h2>
      <p class="small">
        Set a default package + upsells for the leads currently visible in the table below.
        You can still override per lead in the edit form.
      </p>
      <form id="bulkForm" class="edit-form">
        <label>
          Target Package
          <select id="bulkPackage">
            <option value="">(leave as-is)</option>
            <option value="Starter Craft">Starter Craft</option>
            <option value="Business Builder">Business Builder</option>
            <option value="E-Commerce Store">E-Commerce Store</option>
          </select>
        </label>
        <div class="toggle-row">
          <label><input type="checkbox" id="bulkMaint" /> Maintenance Plan</label>
          <label><input type="checkbox" id="bulkDash" /> Dashboard</label>
          <label><input type="checkbox" id="bulkPayLinks" /> Payment Links</label>
          <label><input type="checkbox" id="bulkSEO" /> SEO Setup</label>
          <label><input type="checkbox" id="bulkSocial" /> Social Media Kit</label>
        </div>
        <button class="btn btn-small" id="applyBulkBtn" type="button">Apply to Visible Leads</button>
        <span id="bulkStatus" class="small"></span>
      </form>
    </article>

    <!-- SNAPSHOT TABLE -->
    <article class="card">
      <h2>Lead Snapshot (Latest 20)</h2>
      <p class="small">
        Edit target package and upsells, or delete bad rows. This doesn’t touch older leads beyond the latest 20 you see.
      </p>
      <table id="leadsTable">
        <thead>
          <tr>
            <th>Business</th>
            <th>Phone</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Package</th>
            <th>Upsells</th>
            <th>City</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </article>

    <!-- SINGLE-LEAD EDIT FORM -->
    <article class="card hidden" id="editCard">
      <h2>Edit Lead Targeting</h2>
      <p class="small" id="editLeadLabel"></p>
      <form id="editForm" class="edit-form">
        <input type="hidden" id="editLeadId" />
        <label>
          Target Package
          <select id="editPackage">
            <option value="">(none yet)</option>
            <option value="Starter Craft">Starter Craft</option>
            <option value="Business Builder">Business Builder</option>
            <option value="E-Commerce Store">E-Commerce Store</option>
          </select>
        </label>
        <div class="toggle-row">
          <label><input type="checkbox" id="editMaint" /> Maintenance Plan</label>
          <label><input type="checkbox" id="editDash" /> Dashboard</label>
          <label><input type="checkbox" id="editPayLinks" /> Payment Links</label>
          <label><input type="checkbox" id="editSEO" /> SEO Setup</label>
          <label><input type="checkbox" id="editSocial" /> Social Media Kit</label>
        </div>
        <div style="margin-top:10px;">
          <button class="btn btn-small" type="submit">Save Changes</button>
          <button class="btn btn-small btn-danger" id="cancelEditBtn" type="button">Cancel</button>
        </div>
        <div id="editStatus" class="small"></div>
      </form>
    </article>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const ADMIN_EMAIL = "srarnold216@gmail.com";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan   = document.getElementById("userEmail");
  const logoutBtn       = document.getElementById("logoutBtn");
  const accessMessage   = document.getElementById("accessMessage");
  const leadsContent    = document.getElementById("leadsContent");

  const csvFileInput    = document.getElementById("csvFile");
  const uploadBtn       = document.getElementById("uploadBtn");
  const deleteAllBtn    = document.getElementById("deleteAllBtn");
  const uploadStatus    = document.getElementById("uploadStatus");
  const uploadError     = document.getElementById("uploadError");
  const leadsTableBody  = document.querySelector("#leadsTable tbody");

  const bulkPackageSel  = document.getElementById("bulkPackage");
  const bulkMaint       = document.getElementById("bulkMaint");
  const bulkDash        = document.getElementById("bulkDash");
  const bulkPayLinks    = document.getElementById("bulkPayLinks");
  const bulkSEO         = document.getElementById("bulkSEO");
  const bulkSocial      = document.getElementById("bulkSocial");
  const applyBulkBtn    = document.getElementById("applyBulkBtn");
  const bulkStatus      = document.getElementById("bulkStatus");

  const editCard        = document.getElementById("editCard");
  const editLeadLabel   = document.getElementById("editLeadLabel");
  const editForm        = document.getElementById("editForm");
  const editLeadId      = document.getElementById("editLeadId");
  const editPackageSel  = document.getElementById("editPackage");
  const editMaint       = document.getElementById("editMaint");
  const editDash        = document.getElementById("editDash");
  const editPayLinks    = document.getElementById("editPayLinks");
  const editSEO         = document.getElementById("editSEO");
  const editSocial      = document.getElementById("editSocial");
  const editStatus      = document.getElementById("editStatus");
  const cancelEditBtn   = document.getElementById("cancelEditBtn");

  let leadsCache = []; // latest 20 leads in memory

  function showMsg(text) {
    accessMessage.textContent = text;
  }
  function showLeads() {
    leadsContent.classList.remove("hidden");
  }
  function hideLeads() {
    leadsContent.classList.add("hidden");
  }

  async function initPage() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) {
      console.error("Auth error:", error);
      showMsg("Error checking login. Go back to the Admin Dashboard and log in again.");
      hideLeads();
      return;
    }
    if (!data || !data.user) {
      showMsg("Not signed in. Log in via the Admin Dashboard first, then return here.");
      hideLeads();
      return;
    }

    const email = data.user.email;
    userEmailSpan.textContent = email || "";

    if (email !== ADMIN_EMAIL) {
      showMsg("This page is admin-only. Contractors should use the Contractor Portal.");
      hideLeads();
      return;
    }

    showMsg("Signed in as admin: " + email);
    showLeads();
    loadLeads();
  }

  logoutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    userEmailSpan.textContent = "";
    hideLeads();
    showMsg("Logged out. Go back to the Admin Dashboard to sign in again.");
  });

  async function loadLeads() {
    const { data, error } = await supabaseClient
      .from("call_leads")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(20);

    if (error) {
      console.error("loadLeads error:", error);
      return;
    }

    leadsCache = data || [];
    renderLeadsTable();
  }

  function renderLeadsTable() {
    leadsTableBody.innerHTML = "";
    (leadsCache || []).forEach(ld => {
      const tr = document.createElement("tr");
      tr.dataset.id = ld.id;

      const priority = (ld.priority || "").toString().toUpperCase();
      const status = (ld.call_status || "new").toLowerCase();
      const pkg = ld.target_package || "";
      const upsells = [];
      if (ld.upsell_maintenance) upsells.push("Maint");
      if (ld.upsell_dashboard) upsells.push("Dash");
      if (ld.upsell_payment_links) upsells.push("PayLinks");
      if (ld.upsell_seo) upsells.push("SEO");
      if (ld.upsell_social_kit) upsells.push("Social");

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${ld.business_name || ld.BusinessName || "(No name)"}</strong><br><span class="small">${ld.email || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = ld.phone || ld.Phone || "";
      tr.appendChild(tdPhone);

      const tdPriority = document.createElement("td");
      const spanP = document.createElement("span");
      spanP.className = "priority-badge " + (priority === "A" ? "a" : priority === "B" ? "b" : "c");
      spanP.textContent = priority || "-";
      tdPriority.appendChild(spanP);
      tr.appendChild(tdPriority);

      const tdStatus = document.createElement("td");
      tdStatus.textContent = status;
      tr.appendChild(tdStatus);

      const tdPkg = document.createElement("td");
      tdPkg.textContent = pkg || "-";
      tr.appendChild(tdPkg);

      const tdUpsell = document.createElement("td");
      tdUpsell.textContent = upsells.length ? upsells.join(", ") : "-";
      tr.appendChild(tdUpsell);

      const tdCity = document.createElement("td");
      tdCity.textContent = ld.city || ld.City || "";
      tr.appendChild(tdCity);

      const tdActions = document.createElement("td");
      tdActions.className = "row-actions";
      const editBtn = document.createElement("button");
      editBtn.className = "btn btn-small";
      editBtn.type = "button";
      editBtn.textContent = "Edit";
      editBtn.addEventListener("click", () => openEdit(ld.id));

      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-small btn-danger";
      delBtn.type = "button";
      delBtn.textContent = "Delete";
      delBtn.addEventListener("click", () => deleteLead(ld.id));

      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);
      tr.appendChild(tdActions);

      leadsTableBody.appendChild(tr);
    });
  }

  function parseCsv(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if (!lines.length) return [];
    const headers = lines[0].split(",").map(h => h.trim());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = (cols[idx] || "").trim();
      });
      rows.push(row);
    }
    return rows;
  }

  function parseBoolCell(val) {
    if (!val) return false;
    const v = val.toString().trim().toLowerCase();
    return v === "true" || v === "yes" || v === "y" || v === "1";
  }

  uploadBtn.addEventListener("click", async () => {
    uploadError.textContent = "";
    uploadStatus.textContent = "";

    const file = csvFileInput.files[0];
    if (!file) {
      uploadError.textContent = "Choose a CSV file first.";
      return;
    }

    const text = await file.text();
    const rows = parseCsv(text);
    if (!rows.length) {
      uploadError.textContent = "No rows found in CSV.";
      return;
    }

    uploadStatus.textContent = "Uploading " + rows.length + " leads…";

    const mapped = rows.map(r => ({
      business_name: r.BusinessName || null,
      phone: r.Phone || null,
      email: r.Email || null,
      alt_email: r.AltEmail || null,
      website: r.Website || null,
      social: r.Social || null,
      city: r.City || null,
      state: r.State || null,
      priority: (r.Priority || "A").toUpperCase(),
      call_status: (r.CallStatus || "new").toLowerCase(),
      notes: r.Notes || null,
      target_package: r.TargetPackage || null,
      upsell_maintenance: parseBoolCell(r.UpsellMaintenance),
      upsell_dashboard: parseBoolCell(r.UpsellDashboard),
      upsell_payment_links: parseBoolCell(r.UpsellPaymentLinks),
      upsell_seo: parseBoolCell(r.UpsellSEO),
      upsell_social_kit: parseBoolCell(r.UpsellSocialKit)
    }));

    const { error } = await supabaseClient.from("call_leads").insert(mapped);
    if (error) {
      console.error("Insert error:", error);
      uploadError.textContent = "Error inserting some rows: " + error.message;
      uploadStatus.textContent = "";
      return;
    }

    uploadStatus.textContent = "Leads uploaded successfully.";
    loadLeads();
  });

  async function deleteLead(id) {
    if (!confirm("Delete this lead? This cannot be undone.")) return;

    const { error } = await supabaseClient
      .from("call_leads")
      .delete()
      .eq("id", id);

    if (error) {
      console.error("Delete lead error:", error);
      alert("Error deleting lead: " + error.message);
      return;
    }

    loadLeads();
  }

  deleteAllBtn.addEventListener("click", async () => {
    if (!confirm("Delete ALL leads from call_leads? This cannot be undone.")) return;

    const { error } = await supabaseClient
      .from("call_leads")
      .delete()
      .neq("id", 0); // nuke everything

    if (error) {
      console.error("Delete all error:", error);
      alert("Error deleting all leads: " + error.message);
      return;
    }

    uploadStatus.textContent = "All leads deleted.";
    leadsCache = [];
    renderLeadsTable();
  });

  function openEdit(id) {
    const ld = leadsCache.find(x => x.id === id);
    if (!ld) return;

    editLeadId.value = id;
    const name = ld.business_name || ld.BusinessName || "(No name)";
    editLeadLabel.textContent = "Editing: " + name;
    editPackageSel.value = ld.target_package || "";

    editMaint.checked    = !!ld.upsell_maintenance;
    editDash.checked     = !!ld.upsell_dashboard;
    editPayLinks.checked = !!ld.upsell_payment_links;
    editSEO.checked      = !!ld.upsell_seo;
    editSocial.checked   = !!ld.upsell_social_kit;

    editStatus.textContent = "";
    editCard.classList.remove("hidden");
    editCard.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  cancelEditBtn.addEventListener("click", () => {
    editCard.classList.add("hidden");
    editStatus.textContent = "";
  });

  editForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    editStatus.textContent = "Saving…";

    const id = editLeadId.value;
    if (!id) return;

    const update = {
      target_package: editPackageSel.value || null,
      upsell_maintenance: editMaint.checked,
      upsell_dashboard: editDash.checked,
      upsell_payment_links: editPayLinks.checked,
      upsell_seo: editSEO.checked,
      upsell_social_kit: editSocial.checked
    };

    const { error } = await supabaseClient
      .from("call_leads")
      .update(update)
      .eq("id", id);

    if (error) {
      console.error("Update lead error:", error);
      editStatus.textContent = "Error: " + error.message;
      return;
    }

    editStatus.textContent = "Saved.";
    await loadLeads();
    setTimeout(() => {
      editCard.classList.add("hidden");
      editStatus.textContent = "";
    }, 700);
  });

  applyBulkBtn.addEventListener("click", async () => {
    bulkStatus.textContent = "Applying…";

    if (!leadsCache.length) {
      bulkStatus.textContent = "No leads loaded.";
      return;
    }

    const payload = {};
    if (bulkPackageSel.value) {
      payload.target_package = bulkPackageSel.value;
    }
    payload.upsell_maintenance = bulkMaint.checked;
    payload.upsell_dashboard = bulkDash.checked;
    payload.upsell_payment_links = bulkPayLinks.checked;
    payload.upsell_seo = bulkSEO.checked;
    payload.upsell_social_kit = bulkSocial.checked;

    const ids = leadsCache.map(ld => ld.id);
    const { error } = await supabaseClient
      .from("call_leads")
      .update(payload)
      .in("id", ids);

    if (error) {
      console.error("Bulk update error:", error);
      bulkStatus.textContent = "Error: " + error.message;
      return;
    }

    bulkStatus.textContent = "Updated " + ids.length + " leads.";
    loadLeads();
  });

  initPage();
</script>
</body>
</html>
