<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Leads & CSV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#050713;
      --panel:rgba(255,255,255,.04);
      --border:rgba(255,255,255,.08);
      --text:#f5f5ff;
      --muted:#b5b7d8;
      --grad:linear-gradient(135deg,#6ea8ff,#b166ff);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:
        radial-gradient(1200px 600px at -10% -10%, #18122f 0, rgba(24,18,47,0) 60%),
        var(--bg);
      color:var(--text);
    }
    a{text-decoration:none;color:var(--text);}
    header{
      position:sticky;top:0;z-index:40;
      background:rgba(5,7,19,.95);
      backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:10px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }
    .brand{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand-title{
      font-weight:700;letter-spacing:.08em;font-size:14px;text-transform:uppercase;
    }
    .brand-sub{font-size:12px;color:var(--muted);}
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .nav a{
      font-size:13px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.04);
      text-decoration:none;
      color:var(--text);
      transition:.18s;
    }
    .nav a.primary{
      border-color:transparent;
      background:var(--grad);
      color:#050713;
      font-weight:600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .nav a:hover{
      background:rgba(255,255,255,.10);
      transform:translateY(-1px);
    }
    .nav a.primary:hover{
      filter:brightness(1.05);
    }
    .user-email{font-size:12px;color:var(--muted);}
    .logout-btn{
      border-radius:999px;
      padding:6px 12px;
      border:1px solid rgba(255,255,255,.5);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(110,168,255,.3);
      transition:.18s;
    }
    .logout-btn:hover{
      background:rgba(255,255,255,.16);
      transform:translateY(-1px);
    }

    main{
      max-width:1100px;margin:18px auto 60px;
      padding:0 16px;
    }
    h1{margin:0 0 6px;font-size:22px;}
    .subhead{margin:0 0 18px;font-size:13px;color:var(--muted);}

    .card{
      background:var(--panel);
      border-radius:16px;
      border:1px solid var(--border);
      padding:16px 14px;
      margin-bottom:16px;
    }
    .card h2{margin:0 0 8px;font-size:16px;}
    .card p{margin:0 0 6px;font-size:13px;}
    .small{font-size:12px;color:var(--muted);}

    input[type="file"]{
      margin-top:8px;
      padding:8px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.2);
      background:rgba(8,10,24,.9);
      color:var(--text);
      font-size:13px;
      max-width:100%;
    }
    .btn{
      display:inline-block;
      margin-top:10px;
      padding:8px 14px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:600;
      background:var(--grad);
      color:#050713;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .btn:hover{
      filter:brightness(1.05);
      transform:translateY(-1px);
    }
    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px;}
    th,td{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:5px 4px;
      vertical-align:top;
    }
    th{
      text-align:left;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.05em;
      color:var(--muted);
    }
    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(110,168,255,.15);
    }
    .status-badge{
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(110,168,255,.15);
    }
    .status-badge.a{background:rgba(111,255,193,.15);}
    .status-badge.b{background:rgba(255,230,150,.15);}
    .status-badge.c{background:rgba(255,164,164,.15);}

    .notice{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(255,255,255,.05);
      font-size:12px;
      color:var(--muted);
    }
    .error{
      color:#ffb3b3;
      font-size:12px;
      margin-top:6px;
    }
    .hidden{display:none;}
    .center-msg{
      text-align:center;
      margin-top:40px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <span class="brand-title">BrandCrafters</span>
    <span class="brand-sub">Admin · Leads & CSV</span>
  </div>
  <div class="nav">
    <a href="dashboard.html">Dashboard</a>
    <a href="dashboard-leads-upload.html" class="primary">Leads & CSV</a>
    <a href="contractor-portal.html" target="_blank">Contractor Portal</a>
    <span class="user-email" id="userEmail"></span>
    <button id="logoutBtn" class="logout-btn" type="button">Log Out</button>
  </div>
</header>

<main>
  <section id="accessMessage" class="center-msg hidden"></section>

  <section id="leadsContent" class="hidden">
    <h1>Leads & CSV Upload</h1>
    <p class="subhead">
      Upload CSVs, see top leads, and keep contractors fed. This page is admin-only, but contractors can view leads from their portal.
    </p>

    <article class="card">
      <h2>Upload / Replace Leads CSV</h2>
      <p class="small">
        Upload a CSV with columns like <b>BusinessName, Phone, Email, AltEmail, Website, Social, City, State, Priority, CallStatus, Notes</b>.
        New leads will be inserted; matching existing ones (same BusinessName + Phone) can be updated.
      </p>
      <input type="file" id="csvFile" accept=".csv" />
      <button class="btn" id="uploadBtn" type="button">Upload Leads</button>
      <div id="uploadStatus" class="small"></div>
      <div id="uploadError" class="error"></div>
      <div class="notice">
        Contractors will see these leads in their portal. Once a caller marks a lead as "working", it becomes visible only to them.
      </div>
    </article>

    <article class="card">
      <h2>Lead Snapshot (Latest 20)</h2>
      <p class="small">
        Quick log of your current list. Edit status & details from Supabase or your contractor portal.
      </p>
      <table id="leadsTable">
        <thead>
          <tr>
            <th>Business</th>
            <th>Phone</th>
            <th>Priority</th>
            <th>Status</th>
            <th>City</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </article>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const ADMIN_EMAIL = "srarnold216@gmail.com";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan   = document.getElementById("userEmail");
  const logoutBtn       = document.getElementById("logoutBtn");
  const accessMessage   = document.getElementById("accessMessage");
  const leadsContent    = document.getElementById("leadsContent");

  const csvFileInput    = document.getElementById("csvFile");
  const uploadBtn       = document.getElementById("uploadBtn");
  const uploadStatus    = document.getElementById("uploadStatus");
  const uploadError     = document.getElementById("uploadError");
  const leadsTableBody  = document.querySelector("#leadsTable tbody");

  function showMsg(text) {
    accessMessage.textContent = text;
    accessMessage.classList.remove("hidden");
  }
  function hideMsg() {
    accessMessage.classList.add("hidden");
    accessMessage.textContent = "";
  }

  async function initPage() {
    const { data, error } = await supabaseClient.auth.getUser();
    if (error) {
      console.error("Auth error:", error);
      showMsg("Error checking login. Try refreshing or log in again via the main dashboard.");
      leadsContent.classList.add("hidden");
      return;
    }
    if (!data || !data.user) {
      showMsg("Not signed in. Go to the Admin Dashboard and log in first, then come back here.");
      leadsContent.classList.add("hidden");
      return;
    }

    const email = data.user.email;
    userEmailSpan.textContent = email || "";

    if (email !== ADMIN_EMAIL) {
      showMsg("This page is for admin only. Contractors can work leads from the Contractor Portal.");
      leadsContent.classList.add("hidden");
      return;
    }

    // Admin access allowed
    hideMsg();
    leadsContent.classList.remove("hidden");
    loadLeads();
  }

  logoutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    userEmailSpan.textContent = "";
    showMsg("Logged out. Go to the Admin Dashboard to sign in again.");
    leadsContent.classList.add("hidden");
  });

  async function loadLeads() {
    const { data, error } = await supabaseClient
      .from("call_leads")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(20);

    if (error) {
      console.error("loadLeads error:", error);
      return;
    }

    leadsTableBody.innerHTML = "";
    (data || []).forEach(ld => {
      const tr = document.createElement("tr");
      const priority = (ld.priority || "").toString().toUpperCase();
      const status = (ld.call_status || "new").toLowerCase();

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${ld.business_name || ld.BusinessName || "(No name)"}</strong><br><span class="small">${ld.email || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = ld.phone || ld.Phone || "";
      tr.appendChild(tdPhone);

      const tdPriority = document.createElement("td");
      const spanP = document.createElement("span");
      spanP.className = "status-badge " + (priority === "A" ? "a" : priority === "B" ? "b" : "c");
      spanP.textContent = priority || "-";
      tdPriority.appendChild(spanP);
      tr.appendChild(tdPriority);

      const tdStatus = document.createElement("td");
      tdStatus.textContent = status;
      tr.appendChild(tdStatus);

      const tdCity = document.createElement("td");
      tdCity.textContent = ld.city || ld.City || "";
      tr.appendChild(tdCity);

      leadsTableBody.appendChild(tr);
    });
  }

  // Very simple CSV parser (no redirects; safe)
  function parseCsv(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim().length);
    if (!lines.length) return [];
    const headers = lines[0].split(",").map(h => h.trim());
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(",");
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = (cols[idx] || "").trim();
      });
      rows.push(row);
    }
    return rows;
  }

  uploadBtn.addEventListener("click", async () => {
    uploadError.textContent = "";
    uploadStatus.textContent = "";

    const file = csvFileInput.files[0];
    if (!file) {
      uploadError.textContent = "Choose a CSV file first.";
      return;
    }

    const text = await file.text();
    const rows = parseCsv(text);
    if (!rows.length) {
      uploadError.textContent = "No rows found in CSV.";
      return;
    }

    uploadStatus.textContent = "Uploading " + rows.length + " leads…";

    // Map CSV fields to table columns
    const mapped = rows.map(r => ({
      business_name: r.BusinessName || null,
      phone: r.Phone || null,
      email: r.Email || null,
      alt_email: r.AltEmail || null,
      website: r.Website || null,
      social: r.Social || null,
      city: r.City || null,
      state: r.State || null,
      priority: (r.Priority || "A").toUpperCase(),
      call_status: (r.CallStatus || "new").toLowerCase(),
      notes: r.Notes || null
    }));

    const { error } = await supabaseClient.from("call_leads").insert(mapped);
    if (error) {
      console.error("Insert error:", error);
      uploadError.textContent = "Error inserting some rows: " + error.message;
      uploadStatus.textContent = "";
      return;
    }

    uploadStatus.textContent = "Leads uploaded successfully.";
    loadLeads();
  });

  initPage();
</script>
</body>
      </html>
