<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BrandCrafters — Leads Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(1200px 600px at -10% -10%, #18122f 0, rgba(24,18,47,0) 60%), #050713;
      color: #f5f5ff;
    }
    .dash-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(5,7,19,.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .dash-brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .dash-logo {
      font-weight: 700;
      letter-spacing: .08em;
      font-size: 14px;
      text-transform: uppercase;
    }
    .dash-tagline {
      font-size: 12px;
      opacity: .75;
    }
    .dash-nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .dash-nav a {
      font-size: 13px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.2);
      text-decoration: none;
      color: #f5f5ff;
      opacity: .9;
      transition: .18s;
    }
    .dash-nav a.primary {
      border-color: transparent;
      background: linear-gradient(135deg,#6ea8ff,#b166ff);
      color: #050713;
      font-weight: 600;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .dash-nav a:hover {
      background: rgba(255,255,255,.08);
      transform: translateY(-1px);
    }
    .dash-nav a.primary:hover {
      filter: brightness(1.05);
    }
    .user-email {
      font-size: 12px;
      opacity: .85;
    }
    .logout-btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(255,255,255,.7);
      background: rgba(255,255,255,.08);
      color: #f5f5ff;
      font-size: 12px;
      cursor: pointer;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
      transition:.18s;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,.16);
      transform: translateY(-1px);
    }

    main {
      max-width: 1100px;
      margin: 20px auto 60px;
      padding: 0 16px;
    }
    .dash-title {
      margin-bottom: 10px;
      font-size: 22px;
      font-weight: 700;
    }
    .dash-subtitle {
      font-size: 14px;
      opacity: .8;
      margin-bottom: 18px;
    }

    .card {
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.08);
      padding: 18px 16px;
      margin-bottom: 16px;
    }
    h2 { margin:0 0 8px; }
    label { display:block; font-size:13px; margin-bottom:8px; }
    input[type="file"], select, input[type="date"], input[type="text"] { margin-top:6px; font-size:13px; }
    button {
      border-radius: 10px;
      padding: 7px 10px;
      border: 0;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      transition:.18s;
    }
    button:hover {
      transform: translateY(-1px);
      opacity:.97;
    }
    .btn-primary {
      background: linear-gradient(135deg,#6ea8ff,#b166ff);
      color: #050713;
      margin-right: 8px;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .btn-ghost {
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.7);
      color: #f5f5ff;
      box-shadow:0 0 0 1px rgba(110,168,255,.4);
    }
    .small { font-size: 12px; opacity:.85; }
    .badge {
      display:inline-block;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      background:rgba(110,168,255,.18);
      margin-left:6px;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
    }
    th, td {
      border-bottom:1px solid rgba(255,255,255,.1);
      padding:4px 6px;
      text-align:left;
      vertical-align:top;
    }
    th {
      text-transform:uppercase;
      letter-spacing:.04em;
      font-size:11px;
      opacity:.75;
    }
    .error { color:#ff9b9b; margin-top:6px; font-size:12px; }
    .success { color:#9bffbf; margin-top:6px; font-size:12px; }

    .grid-overview {
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:10px;
    }
    .stat-card {
      background:rgba(5,7,19,.8);
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      padding:10px 12px;
    }
    .stat-label { font-size:11px; text-transform:uppercase; letter-spacing:.06em; opacity:.7; }
    .stat-value { font-size:18px; font-weight:700; margin-top:4px; }
    .stat-sub { font-size:11px; opacity:.75; margin-top:2px; }

    .filters-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-bottom:10px;
    }
    .filters-row label {
      margin-bottom:0;
    }

    @media (max-width: 900px) {
      .grid-overview { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 600px) {
      .grid-overview { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<header class="dash-header">
  <div class="dash-brand">
    <div class="dash-logo">BrandCrafters</div>
    <div class="dash-tagline">Admin · Leads Dashboard</div>
  </div>
  <nav class="dash-nav">
    <a href="dashboard.html">Main Dashboard</a>
    <a href="contractor-portal.html" target="_blank">Contractor Portal</a>
    <a href="dashboard-leads-upload.html" class="primary">Leads & CSV</a>
    <span class="user-email" id="userEmail"></span>
    <button id="logoutBtn" class="logout-btn">Log Out</button>
  </nav>
</header>

<main>
  <div class="dash-title">Leads Overview & Import</div>
  <div class="dash-subtitle">
    View contractor productivity and manage lead lists that feed the Contractor Portal.
    <span class="badge">Admin Only</span>
  </div>

  <!-- OVERVIEW CARD -->
  <section class="card" id="overviewCard">
    <h2>Leads Overview</h2>
    <p class="small">Productivity snapshot across all contractors.</p>
    <div class="filters-row">
      <div>
        <label>Filter by Caller
          <select id="callerFilter">
            <option value="">All callers</option>
          </select>
        </label>
      </div>
      <div>
        <label>Filter by Status
          <select id="overviewStatusFilter">
            <option value="">All statuses</option>
            <option>new</option>
            <option>left vm</option>
            <option>talked - follow up</option>
            <option>not interested</option>
            <option>closed won</option>
          </select>
        </label>
      </div>
    </div>

    <div class="grid-overview" id="overviewStats"></div>
  </section>

  <!-- PRODUCTIVITY BY CALLER -->
  <section class="card">
    <h2>Productivity by Caller</h2>
    <p class="small">
      Per-caller breakdown — how many leads they’re touching, how much money they’ve closed, and estimated commission.
    </p>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Caller</th>
            <th>Total Leads</th>
            <th>Assigned Leads</th>
            <th>New</th>
            <th>Follow-Up</th>
            <th>Closed Won</th>
            <th>Closed Won Revenue</th>
            <th>Commission Est.</th>
            <th>Last Activity</th>
          </tr>
        </thead>
        <tbody id="callerStatsBody"></tbody>
      </table>
    </div>
  </section>

  <!-- UPLOAD CARD -->
  <section class="card">
    <h2>Upload Call Leads CSV</h2>
    <p class="small">
      Export your <b>Call_Leads</b> from Excel/Google Sheets as CSV. Expected headers:<br>
      <code>Priority, Date_Added, Business_Name, Contact_Name, Phone_Primary, Phone_Alt, Email_Primary, Email_Alt, Social_1, Social_2, City, State, Current_Online_Presence, Recommended_Package, Est_Budget, Decision_Maker_YN, Interest_Level_1_5, Last_Contact_Date, Next_Follow_Up, Call_Status, Notes, Assigned_Caller, Sold_Package, Final_Price, AddOns_Sold, FollowUp_Channel</code>
    </p>

    <label>
      CSV File
      <input type="file" id="csvFile" accept=".csv" />
    </label>

    <div style="margin-top:10px;">
      <button id="previewBtn" class="btn-primary">Preview</button>
      <button id="uploadBtn" class="btn-ghost" disabled>Upload to Supabase</button>
    </div>
    <div id="msg" class="small" style="margin-top:8px;"></div>
  </section>

  <!-- PREVIEW CARD -->
  <section class="card">
    <h2>CSV Preview (first 20 rows)</h2>
    <div style="overflow-x:auto;">
      <table id="previewTable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- ADMIN LEADS TABLE -->
  <section class="card">
    <h2>All Leads (Admin View)</h2>
    <p class="small">Same list your contractors see, but across everyone. You can also assign/unassign leads from here.</p>

    <div class="filters-row">
      <div>
        <label>Status
          <select id="adminStatusFilter">
            <option value="">All</option>
            <option>new</option>
            <option>left vm</option>
            <option>talked - follow up</option>
            <option>not interested</option>
            <option>closed won</option>
          </select>
        </label>
      </div>
      <div>
        <label>Priority
          <select id="adminPriorityFilter">
            <option value="">All</option>
            <option>A</option>
            <option>B</option>
            <option>C</option>
          </select>
        </label>
      </div>
      <div>
        <label>Caller
          <select id="adminCallerFilter">
            <option value="">All</option>
          </select>
        </label>
      </div>
    </div>

    <div style="overflow-x:auto;">
      <table id="adminLeadsTable">
        <thead>
          <tr>
            <th>Priority</th>
            <th>Business</th>
            <th>Caller</th>
            <th>Status</th>
            <th>Interest</th>
            <th>Next Follow-Up</th>
            <th>Last Contact</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  const SUPABASE_URL = "https://vekoulqehexqosgwacwa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiIsInZla291bHFlaGV4cW9zZ3dhY3dhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNTYxNTUsImV4cCI6MjA3ODczMjE1NX0.B9gSHAb_cLCcjCzXM5FegDIKsuQwHCqAFXslfAzzrQ4";
  const LOGIN_PAGE_URL = "dashboard-login.html";
  const ADMIN_EMAIL = "srarnold216@gmail.com";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const userEmailSpan = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");

  const csvInput = document.getElementById("csvFile");
  const previewBtn = document.getElementById("previewBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const msg = document.getElementById("msg");
  const previewHead = document.querySelector("#previewTable thead");
  const previewBody = document.querySelector("#previewTable tbody");

  const callerFilter = document.getElementById("callerFilter");
  const overviewStatusFilter = document.getElementById("overviewStatusFilter");
  const overviewStats = document.getElementById("overviewStats");

  const callerStatsBody = document.getElementById("callerStatsBody");

  const adminStatusFilter = document.getElementById("adminStatusFilter");
  const adminPriorityFilter = document.getElementById("adminPriorityFilter");
  const adminCallerFilter = document.getElementById("adminCallerFilter");
  const adminLeadsTableBody = document.querySelector("#adminLeadsTable tbody");

  let parsedRows = [];
  let allLeads = [];

  async function guardAdminAndLoad() {
    const { data } = await supabaseClient.auth.getUser();
    if (!data || !data.user) {
      window.location.href = LOGIN_PAGE_URL;
      return;
    }
    const email = data.user.email;
    userEmailSpan.textContent = email;

    if (email !== ADMIN_EMAIL) {
      window.location.href = "contractor-portal.html";
      return;
    }

    await loadLeadsFromDB();
  }

  logoutBtn.addEventListener("click", async () => {
    await supabaseClient.auth.signOut();
    window.location.href = LOGIN_PAGE_URL;
  });

  async function loadLeadsFromDB() {
    const { data, error } = await supabaseClient
      .from("call_leads")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Error loading leads:", error);
      return;
    }
    allLeads = data || [];
    buildCallerOptions();
    renderOverview();
    renderCallerStats();
    renderAdminLeads();
  }

  function buildCallerOptions() {
    const callers = [...new Set(allLeads.map(l => l.assigned_caller_email).filter(Boolean))];
    callerFilter.innerHTML = '<option value="">All callers</option>';
    adminCallerFilter.innerHTML = '<option value="">All</option>';
    callers.forEach(email => {
      const opt1 = document.createElement("option");
      opt1.value = email;
      opt1.textContent = email;
      callerFilter.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = email;
      opt2.textContent = email;
      adminCallerFilter.appendChild(opt2);
    });
  }

  function renderOverview() {
    const selCaller = callerFilter.value;
    const selStatus = overviewStatusFilter.value.toLowerCase();

    const filtered = allLeads.filter(ld => {
      const callerOk = !selCaller || ld.assigned_caller_email === selCaller;
      const statusOk = !selStatus || (ld.call_status || "").toLowerCase() === selStatus;
      return callerOk && statusOk;
    });

    const total = filtered.length;
    const byStatus = {
      new: 0,
      "left vm": 0,
      "talked - follow up": 0,
      "not interested": 0,
      "closed won": 0
    };
    let closedWonRev = 0;
    let unassignedCount = 0;

    filtered.forEach(ld => {
      const s = (ld.call_status || "").toLowerCase();
      if (!ld.assigned_caller_email) unassignedCount += 1;
      if (byStatus[s] !== undefined) byStatus[s] += 1;
      if (s === "closed won" && ld.final_price) {
        closedWonRev += Number(ld.final_price) || 0;
      }
    });

    overviewStats.innerHTML = "";

    const cards = [
      {
        label: "Total Leads",
        value: total,
        sub: "Filtered by caller/status"
      },
      {
        label: "Unassigned (Pool)",
        value: unassignedCount,
        sub: "Available for any caller"
      },
      {
        label: "New",
        value: byStatus["new"],
        sub: "Ready to call"
      },
      {
        label: "Talked / Follow-Up",
        value: byStatus["talked - follow up"],
        sub: "Active pipeline"
      },
      {
        label: "Closed Won",
        value: byStatus["closed won"],
        sub: "Deals closed"
      },
      {
        label: "Left Voicemail",
        value: byStatus["left vm"],
        sub: "Need callbacks"
      },
      {
        label: "Not Interested",
        value: byStatus["not interested"],
        sub: "Dead leads"
      },
      {
        label: "Closed Won Revenue",
        value: "$" + closedWonRev.toFixed(2),
        sub: "Sum of final_price"
      }
    ];

    cards.forEach(c => {
      const div = document.createElement("div");
      div.className = "stat-card";
      div.innerHTML = `
        <div class="stat-label">${c.label}</div>
        <div class="stat-value">${c.value}</div>
        <div class="stat-sub">${c.sub}</div>
      `;
      overviewStats.appendChild(div);
    });
  }

  function renderCallerStats() {
    callerStatsBody.innerHTML = "";

    const map = new Map();
    allLeads.forEach(ld => {
      if (!ld.assigned_caller_email) return;
      const email = ld.assigned_caller_email;
      if (!map.has(email)) {
        map.set(email, {
          caller: email,
          total: 0,
          assigned: 0,
          new: 0,
          follow: 0,
          won: 0,
          revenue: 0,
          commission: 0,
          lastActivity: null
        });
      }
      const bucket = map.get(email);
      bucket.total += 1;
      bucket.assigned += 1;

      const s = (ld.call_status || "").toLowerCase();
      if (s === "new") bucket.new += 1;
      if (s === "talked - follow up") bucket.follow += 1;
      if (s === "closed won") {
        bucket.won += 1;
        bucket.commission += 100; // $100 per closed website sale
      }

      if (s === "closed won" && ld.final_price) {
        bucket.revenue += Number(ld.final_price) || 0;
      }

      const candidates = [];
      if (ld.last_contact_date) candidates.push(ld.last_contact_date);
      if (ld.next_follow_up) candidates.push(ld.next_follow_up);
      if (ld.created_at) candidates.push(ld.created_at.split("T")[0]);

      candidates.forEach(dStr => {
        const t = new Date(dStr);
        if (!bucket.lastActivity || t > bucket.lastActivity) {
          bucket.lastActivity = t;
        }
      });
    });

    const rows = Array.from(map.values()).sort((a, b) => {
      if (b.commission !== a.commission) return b.commission - a.commission;
      return b.won - a.won;
    });

    if (!rows.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 9;
      td.textContent = "No callers with assigned leads yet.";
      td.className = "small";
      tr.appendChild(td);
      callerStatsBody.appendChild(tr);
      return;
    }

    rows.forEach(r => {
      const tr = document.createElement("tr");

      const tdCaller = document.createElement("td");
      tdCaller.textContent = r.caller;
      tr.appendChild(tdCaller);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = r.total;
      tr.appendChild(tdTotal);

      const tdAssigned = document.createElement("td");
      tdAssigned.textContent = r.assigned;
      tr.appendChild(tdAssigned);

      const tdNew = document.createElement("td");
      tdNew.textContent = r.new;
      tr.appendChild(tdNew);

      const tdFollow = document.createElement("td");
      tdFollow.textContent = r.follow;
      tr.appendChild(tdFollow);

      const tdWon = document.createElement("td");
      tdWon.textContent = r.won;
      tr.appendChild(tdWon);

      const tdRev = document.createElement("td");
      tdRev.textContent = "$" + r.revenue.toFixed(2);
      tr.appendChild(tdRev);

      const tdComm = document.createElement("td");
      tdComm.textContent = "$" + r.commission.toFixed(2);
      tr.appendChild(tdComm);

      const tdLast = document.createElement("td");
      tdLast.textContent = r.lastActivity
        ? r.lastActivity.toISOString().slice(0, 10)
        : "";
      tr.appendChild(tdLast);

      callerStatsBody.appendChild(tr);
    });
  }

  function renderAdminLeads() {
    const sVal = adminStatusFilter.value.toLowerCase();
    const pVal = adminPriorityFilter.value.toUpperCase();
    const cVal = adminCallerFilter.value;

    adminLeadsTableBody.innerHTML = "";

    const filtered = allLeads.filter(ld => {
      const s = (ld.call_status || "").toLowerCase();
      const p = (ld.priority || "").toUpperCase();
      const caller = ld.assigned_caller_email || "";
      const statusOk = !sVal || s === sVal;
      const prioOk = !pVal || p === pVal;
      const callerOk = !cVal || caller === cVal;
      return statusOk && prioOk && callerOk;
    });

    filtered.forEach(ld => {
      const tr = document.createElement("tr");

      const tdPr = document.createElement("td");
      tdPr.textContent = ld.priority || "";
      tr.appendChild(tdPr);

      const tdBiz = document.createElement("td");
      tdBiz.innerHTML = `<strong>${ld.business_name || ""}</strong><br><span class="small">${ld.city || ""}, ${ld.state || ""}</span>`;
      tr.appendChild(tdBiz);

      const tdCaller = document.createElement("td");
      tdCaller.innerHTML = `<span class="small">${ld.assigned_caller_email || "Unassigned"}</span>`;
      tr.appendChild(tdCaller);

      const tdStatus = document.createElement("td");
      tdStatus.textContent = ld.call_status || "";
      tr.appendChild(tdStatus);

      const tdInterest = document.createElement("td");
      tdInterest.textContent = ld.interest_level != null ? ld.interest_level : "";
      tr.appendChild(tdInterest);

      const tdNext = document.createElement("td");
      tdNext.textContent = ld.next_follow_up || "";
      tr.appendChild(tdNext);

      const tdLast = document.createElement("td");
      tdLast.textContent = ld.last_contact_date || "";
      tr.appendChild(tdLast);

      const tdCreated = document.createElement("td");
      tdCreated.textContent = ld.date_added || (ld.created_at ? ld.created_at.split("T")[0] : "");
      tr.appendChild(tdCreated);

      const tdActions = document.createElement("td");
      const assignBtn = document.createElement("button");
      assignBtn.textContent = "Assign";
      assignBtn.className = "btn-ghost";
      assignBtn.addEventListener("click", () => {
        const current = ld.assigned_caller_email || "";
        const email = prompt("Assign to caller email (leave blank to unassign):", current);
        if (email === null) return;
        assignLead(ld.id, email.trim() || null);
      });
      tdActions.appendChild(assignBtn);
      tr.appendChild(tdActions);

      adminLeadsTableBody.appendChild(tr);
    });
  }

  async function assignLead(id, email) {
    const { error } = await supabaseClient
      .from("call_leads")
      .update({ assigned_caller_email: email || null })
      .eq("id", id);

    if (error) {
      alert("Error assigning lead: " + error.message);
    } else {
      await loadLeadsFromDB();
    }
  }

  function mapRowToCallLead(row) {
    return {
      priority: row["Priority"] || null,
      date_added: row["Date_Added"] || null,
      business_name: row["Business_Name"] || null,
      contact_name: row["Contact_Name"] || null,
      phone_primary: row["Phone_Primary"] || null,
      phone_alt: row["Phone_Alt"] || null,
      email_primary: row["Email_Primary"] || null,
      email_alt: row["Email_Alt"] || null,
      social_1: row["Social_1"] || null,
      social_2: row["Social_2"] || null,
      city: row["City"] || null,
      state: row["State"] || null,
      current_online_presence: row["Current_Online_Presence"] || null,
      recommended_package: row["Recommended_Package"] || null,
      est_budget: row["Est_Budget"] || null,
      decision_maker_yn: row["Decision_Maker_YN"] || null,
      interest_level: row["Interest_Level_1_5"] ? parseInt(row["Interest_Level_1_5"], 10) : null,
      last_contact_date: row["Last_Contact_Date"] || null,
      next_follow_up: row["Next_Follow_Up"] || null,
      call_status: row["Call_Status"] || null,
      notes: row["Notes"] || null,
      assigned_caller_email: row["Assigned_Caller"] || null,
      sold_package: row["Sold_Package"] || null,
      final_price: row["Final_Price"] ? parseFloat(row["Final_Price"]) : null,
      addons_sold: row["AddOns_Sold"] || null,
      followup_channel: row["FollowUp_Channel"] || null
    };
  }

  previewBtn.addEventListener("click", () => {
    msg.textContent = "";
    msg.className = "small";
    previewHead.innerHTML = "";
    previewBody.innerHTML = "";
    uploadBtn.disabled = true;
    parsedRows = [];

    const file = csvInput.files && csvInput.files[0];
    if (!file) {
      msg.textContent = "Please choose a CSV file.";
      msg.className = "small error";
      return;
    }

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        parsedRows = results.data;
        if (!parsedRows.length) {
          msg.textContent = "CSV appears empty.";
          msg.className = "small error";
          return;
        }

        const headers = results.meta.fields || [];
        if (!headers.length) {
          msg.textContent = "Could not read headers from CSV.";
          msg.className = "small error";
          return;
        }

        const headRow = document.createElement("tr");
        headers.forEach(h => {
          const th = document.createElement("th");
          th.textContent = h;
          headRow.appendChild(th);
        });
        previewHead.appendChild(headRow);

        parsedRows.slice(0, 20).forEach(r => {
          const tr = document.createElement("tr");
          headers.forEach(h => {
            const td = document.createElement("td");
            td.textContent = r[h];
            tr.appendChild(td);
          });
          previewBody.appendChild(tr);
        });

        msg.textContent = "Preview loaded. If it looks correct, click 'Upload to Supabase'.";
        msg.className = "small";
        uploadBtn.disabled = false;
      },
      error: function(err) {
        msg.textContent = "Error parsing CSV: " + err.message;
        msg.className = "small error";
      }
    });
  });

  uploadBtn.addEventListener("click", async () => {
    if (!parsedRows.length) {
      msg.textContent = "Nothing to upload. Please preview first.";
      msg.className = "small error";
      return;
    }
    msg.textContent = "Uploading leads to Supabase...";
    msg.className = "small";
    uploadBtn.disabled = true;

    const payload = parsedRows.map(mapRowToCallLead);
    const chunkSize = 200;

    for (let i = 0; i < payload.length; i += chunkSize) {
      const chunk = payload.slice(i, i + chunkSize);
      const { error } = await supabaseClient
        .from("call_leads")
        .insert(chunk);

      if (error) {
        msg.textContent = "Error uploading: " + error.message;
        msg.className = "small error";
        uploadBtn.disabled = false;
        return;
      }
    }

    msg.textContent = "Upload complete! Contractors will now see these leads in their portal.";
    msg.className = "small success";
    uploadBtn.disabled = false;

    await loadLeadsFromDB();
  });

  callerFilter.addEventListener("change", () => {
    renderOverview();
  });
  overviewStatusFilter.addEventListener("change", () => {
    renderOverview();
  });

  adminStatusFilter.addEventListener("change", renderAdminLeads);
  adminPriorityFilter.addEventListener("change", renderAdminLeads);
  adminCallerFilter.addEventListener("change", renderAdminLeads);

  guardAdminAndLoad();
</script>
</body>
                                    </html>
